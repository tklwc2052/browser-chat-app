<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body class="profile-page-body">

<div class="d-profile-card">
    
    <div class="d-banner" id="p-banner"></div>

    <div class="d-avatar-wrapper">
        <img id="p-avatar" class="d-avatar" src="placeholder-avatar.png">
        <div class="d-status-indicator" id="p-status"></div>
    </div>

    <div class="d-content">
        
        <div class="d-header-info">
            <input type="text" id="p-displayname" class="d-displayname" placeholder="Display Name" readonly>
            
            <div id="p-username" class="d-username">@loading...</div>
            
            <input type="text" id="p-pronouns" class="d-pronouns" placeholder="Add pronouns" readonly>
        </div>

        <div style="height: 1px; background-color: #3f4147; width: 100%; margin: 10px 0;"></div>

        <div class="d-section">
            <label class="d-label">About Me</label>
            <textarea id="p-about" class="d-text-area" rows="3" placeholder="No description set." readonly></textarea>
        </div>

        <div class="d-section" id="section-avatar-url" style="display:none;">
            <label class="d-label">Avatar Image Link</label>
            <input type="text" id="p-avatar-url" class="d-input-line" placeholder="Paste image link here...">
        </div>

        <div class="d-section">
            <label class="d-label">Last Seen</label>
            <div id="p-lastseen" class="d-text-static">Now</div>
        </div>

        <div class="d-edit-controls">
            <button id="btn-save" class="d-btn d-btn-primary" style="display:none;">Save Profile</button>
            <button id="btn-close" class="d-btn d-btn-secondary">Close</button>
        </div>
        
    </div>
</div>

<script>
    const socket = io();
    const myUsername = localStorage.getItem('simplechat_username');
    
    // Parse URL params
    const urlParams = new URLSearchParams(window.location.search);
    const targetParam = urlParams.get('user');
    
    // Determine if we are editing OURSELVES or viewing SOMEONE ELSE
    const isSelf = !targetParam || (targetParam.toLowerCase() === myUsername.toLowerCase());
    const targetUser = targetParam || myUsername;

    // DOM Elements
    const elBanner = document.getElementById('p-banner');
    const elAvatar = document.getElementById('p-avatar');
    const elStatus = document.getElementById('p-status');
    const elDisplay = document.getElementById('p-displayname');
    const elUser = document.getElementById('p-username');
    const elPronouns = document.getElementById('p-pronouns');
    const elAbout = document.getElementById('p-about');
    const elLastSeen = document.getElementById('p-lastseen');
    const elAvatarUrl = document.getElementById('p-avatar-url');
    const sectionAvatarUrl = document.getElementById('section-avatar-url');
    
    const btnSave = document.getElementById('btn-save');
    const btnClose = document.getElementById('btn-close');

    // --- SETUP COLORS ---
    const bannerColors = ['#5865F2', '#ED4245', '#3BA55C', '#FAA61A', '#EB459E', '#00ACE6'];
    function setBannerColor(name) {
        const index = name.length % bannerColors.length;
        elBanner.style.backgroundColor = bannerColors[index];
    }

    // --- INITIALIZE UI ---
    if (isSelf) {
        // EDIT MODE
        btnSave.style.display = 'block';
        sectionAvatarUrl.style.display = 'block'; // Show avatar link input
        
        // Make inputs editable
        elDisplay.readOnly = false;
        elPronouns.readOnly = false;
        elAbout.readOnly = false;
        elDisplay.style.cursor = 'text';
        
        // Load MY data
        socket.emit('set-username', { username: myUsername });
        socket.on('profile-info', (data) => {
            populateData(data);
            elAvatarUrl.value = (data.avatar && data.avatar !== 'placeholder-avatar.png') ? data.avatar : '';
        });

        // Live preview for avatar
        elAvatarUrl.addEventListener('input', () => {
            elAvatar.src = elAvatarUrl.value || 'placeholder-avatar.png';
        });

        // SAVE Handler
        btnSave.onclick = () => {
            const updates = {
                displayName: elDisplay.value,
                description: elAbout.value,
                pronouns: elPronouns.value,
                avatar: elAvatarUrl.value || 'placeholder-avatar.png'
            };
            socket.emit('update-profile', updates);
            btnSave.innerText = "Saved!";
            setTimeout(() => btnSave.innerText = "Save Profile", 2000);
        };

    } else {
        // VIEW MODE (Read Only)
        btnSave.style.display = 'none';
        sectionAvatarUrl.style.display = 'none';
        
        // Fetch target data
        socket.emit('get-user-profile', targetUser);
        socket.on('user-profile-data', (data) => {
            if (data.notFound) {
                elDisplay.value = "User not found";
                elUser.innerText = "---";
                return;
            }
            populateData(data);
        });
    }

    function populateData(data) {
        elDisplay.value = data.displayName || data.username;
        elUser.innerText = "@" + data.username;
        elPronouns.value = data.pronouns || "";
        elAbout.value = data.description || "";
        elAvatar.src = data.avatar || 'placeholder-avatar.png';
        
        setBannerColor(data.username);

        // Handle Last Seen
        if (data.lastSeen) {
            elLastSeen.innerText = new Date(data.lastSeen).toLocaleString();
        } else {
            elLastSeen.innerText = "Unknown";
        }
    }

    btnClose.onclick = () => {
        window.location.href = '/';
    }
</script>
</body>
</html>
