<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body class="profile-page-body">

<div class="d-profile-card">
    
    <div class="d-banner" id="p-banner"></div>

    <div class="d-avatar-wrapper">
        <img id="p-avatar" class="d-avatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjNTg2NUYyIi8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEyIDEyYzIuMjEgMCDoLTMS43OSA0LTdzLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==">
        <div class="d-status-indicator" id="p-status"></div>
    </div>

    <div class="d-content">
        
        <div class="d-header-info">
            <input type="text" id="p-displayname" class="d-displayname" placeholder="Display Name" readonly>
            <div id="p-username" class="d-username">@loading...</div>
            <input type="text" id="p-pronouns" class="d-pronouns" placeholder="Add pronouns" readonly>
        </div>

        <div style="height: 1px; background-color: #3f4147; width: 100%; margin: 10px 0;"></div>

        <div class="d-section">
            <label class="d-label">About Me</label>
            <textarea id="p-about" class="d-text-area" rows="3" placeholder="Description" readonly></textarea>
        </div>

        <div class="d-section" id="section-custom-bg" style="display:none; margin-top:10px;">
            <label class="d-label">Profile Theme (Image URL)</label>
            <input type="text" id="p-custom-bg" class="d-text-area" style="height:30px;" placeholder="https://example.com/bg.jpg" readonly>
        </div>

        <div class="d-edit-controls" id="edit-controls" style="display: none;">
            <input type="file" id="p-avatar-upload" style="display: none;" accept="image/*">
            <button class="d-btn d-btn-secondary" onclick="document.getElementById('p-avatar-upload').click()">Change Avatar</button>
            <button class="d-btn d-btn-primary" id="btn-save">Save Changes</button>
        </div>
        
    </div>
</div>

<button id="close-btn" style="position: fixed; top: 20px; right: 20px; background: transparent; color: white; border: 1px solid #555; padding: 10px 20px; cursor: pointer; border-radius: 5px;">Back to Chat</button>

<script>
    const socket = io();
    
    // Config: Base64 string for offline support
    const DEFAULT_AVATAR = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjNTg2NUYyIi8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEyIDEyYzIuMjEgMCDoLTMS43OSA0LTdzLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==";

    const elAvatar = document.getElementById('p-avatar');
    const elBanner = document.getElementById('p-banner');
    const elDisplay = document.getElementById('p-displayname');
    const elUser = document.getElementById('p-username');
    const elPronouns = document.getElementById('p-pronouns');
    const elAbout = document.getElementById('p-about');
    const elStatus = document.getElementById('p-status');
    const editControls = document.getElementById('edit-controls');
    const btnSave = document.getElementById('btn-save');
    const uploadInput = document.getElementById('p-avatar-upload');
    const btnClose = document.getElementById('close-btn');
    const sectionCustomBg = document.getElementById('section-custom-bg');
    const elCustomBg = document.getElementById('p-custom-bg');

    const params = new URLSearchParams(window.location.search);
    let targetUser = params.get('user');
    const viewMode = params.get('mode') || 'edit'; 

    let stagedAvatar = null;
    let currentUserData = {};

    socket.on('connect', () => {
        const myUser = localStorage.getItem('simplechat_username');
        if (!targetUser) targetUser = myUser; 
        
        socket.emit('set-username', { username: myUser });

        if (targetUser === myUser && viewMode !== 'view') {
            enableEditing();
            loadProfile(myUser);
        } else {
            loadProfile(targetUser);
        }
    });

    function enableEditing() {
        editControls.style.display = 'flex';
        elDisplay.removeAttribute('readonly');
        elPronouns.removeAttribute('readonly');
        elAbout.removeAttribute('readonly');
        elCustomBg.removeAttribute('readonly');
        sectionCustomBg.style.display = 'block';
        
        elDisplay.classList.add('editable');
        elPronouns.classList.add('editable');
        elAbout.classList.add('editable');
    }

    function loadProfile(username) {
        socket.emit('get-user-profile', username);
        socket.on('user-profile-data', (data) => {
            if (data.notFound) {
                elDisplay.value = "User not found";
                elUser.innerText = "---";
                return;
            }
            populateData(data);
        });
    }

    function populateData(data) {
        currentUserData = data;
        elDisplay.value = data.displayName || data.username;
        elUser.innerText = "@" + data.username;
        elPronouns.value = data.pronouns || "";
        elAbout.value = data.description || "";
        elCustomBg.value = data.customBackground || "";
        
        // Use Data Image if avatar is null
        elAvatar.src = data.avatar || DEFAULT_AVATAR;
        
        setBannerColor(data.username);

        if (data.online) {
            elStatus.style.backgroundColor = "#23a559"; 
        } else {
            elStatus.style.backgroundColor = "#747f8d"; 
        }

        if (data.customBackground) {
            document.body.style.backgroundImage = `url('${data.customBackground}')`;
            document.body.style.backgroundSize = "cover";
            document.body.style.backgroundPosition = "center";
        }
    }

    function setBannerColor(username) {
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
        const hex = "00000".substring(0, 6 - c.length) + c;
        elBanner.style.backgroundColor = "#" + hex;
    }

    uploadInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                stagedAvatar = ev.target.result;
                elAvatar.src = stagedAvatar;
            }
            reader.readAsDataURL(file);
        }
    };

    btnSave.onclick = () => {
        const updateData = {
            displayName: elDisplay.value,
            pronouns: elPronouns.value,
            description: elAbout.value,
            customBackground: elCustomBg.value
        };
        if (stagedAvatar) {
            updateData.avatar = stagedAvatar;
        }

        socket.emit('update-profile', updateData);
        alert("Profile Updated!");
    };

    btnClose.onclick = () => {
        window.location.href = '/';
    }
</script>
</body>
</html>
