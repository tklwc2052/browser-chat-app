<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>

<style>
    /* 1. Stack the Name and the Bubble vertically */
    .message-content-area {
        display: flex;
        flex-direction: column;
        max-width: 70%;
        position: relative;
    }

    /* 2. Style the Name Tag */
    .message-sender-name {
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 2px;
        margin-left: 4px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    /* 3. Align your own messages to the right */
    .user-message .message-content-area {
        align-items: flex-end;
    }
    
    /* Align your own name to the right */
    .user-message .message-sender-name {
        margin-right: 4px;
        margin-left: 0;
        color: #00ACE6;
    }
</style>
</head>
<body>
<div id="main-wrapper">

    <div id="dm-sidebar">
        <div id="sidebar-header">
            <h3>Users</h3>
            <button id="close-sidebar-btn" class="mobile-only">‚úï</button>
        </div>
        <ul id="user-list"></ul>
    </div>

    <div id="right-panel">
        <div id="top-bar">
            <button id="toggle-sidebar-btn">‚ò∞</button>
            <h2 id="chat-title">Global Chat</h2>
            <div id="vc-controls">
                <button id="join-vc-btn" class="vc-btn">Join Call</button>
                <button id="leave-vc-btn" class="vc-btn hidden" style="background-color: #d32f2f;">Leave</button>
                <button id="mute-vc-btn" class="vc-btn hidden">Mute</button>
            </div>
            
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                 <div id="theme-toggle" title="Toggle Theme">üåô</div>
                 <div id="settings-btn" title="Settings">‚öôÔ∏è</div>
            </div>

             <div id="settings-dropdown" class="dropdown-content">
                <ul class="settings-list">
                    <li class="setting-item">
                        <span>Sound Notifications</span>
                        <input type="checkbox" id="setting-sound" checked>
                    </li>
                    <li class="setting-item">
                        <span>Popup Notifications</span>
                        <input type="checkbox" id="setting-popup" checked>
                    </li>
                    <li class="setting-item">
                        <span>Transparent Mode</span>
                        <input type="checkbox" id="setting-transparent">
                    </li>
                    <li class="setting-item">
                        <button id="logout-btn" style="width: 100%; background: #d32f2f; border:none; color:white; padding:5px; border-radius:4px; cursor:pointer;">Logout / Change Name</button>
                    </li>
                </ul>
            </div>
        </div>

        <div id="vc-area">
            <div id="vc-status">Voice Chat: Idle</div>
            <div id="vc-users"></div> 
        </div>

        <div id="chat-window">
            <div id="messages"></div>
            <div id="typing-indicator"></div>
        </div>

        <div id="reply-bar" style="display:none; background: rgba(0,0,0,0.2); padding: 8px; border-left: 4px solid #00ACE6; display: flex; justify-content: space-between; align-items: center;">
            <div id="reply-content" style="font-size: 0.9em; color: #ccc;">Replying to...</div>
            <button id="cancel-reply-btn" style="background:transparent; border:none; color: #fff; cursor:pointer; font-weight:bold;">‚úï</button>
        </div>

        <div id="input-area">
            <div id="image-preview-area">
                <img id="image-preview" src="" alt="Preview">
                <button id="remove-image-btn">√ó</button>
            </div>

            <div id="message-input-area">
                <button id="upload-btn">üì∑</button>
                <input type="file" id="hidden-file-input" accept="image/*" hidden>
                
                <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>
</div>

<div id="login-overlay">
    <div id="login-box">
        <h2>Enter Your Name</h2>
        <input type="text" id="username-input" placeholder="Username..." maxlength="15">
        
        <div style="margin: 15px 0; text-align: left;">
            <label style="font-size: 0.9em; color: #bbb;">Choose Avatar (Optional)</label>
            <input type="text" id="avatar-input" placeholder="Paste Image URL..." style="width: 100%; margin-top: 5px; padding: 8px; box-sizing: border-box; background: #333; border: 1px solid #444; color: white; border-radius: 4px;">
            <p style="font-size: 0.8em; color: #888; margin-top: 5px;">Leave empty for default.</p>
        </div>

        <button id="join-btn">Join Chat</button>
    </div>
</div>

<div id="dev-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
    <div style="background: #1e1e1e; padding: 30px; border-radius: 8px; border: 2px solid #00ACE6; max-width: 500px; text-align: center; box-shadow: 0 0 50px rgba(0,172,230,0.2);">
        <h2 style="color: #00ACE6; margin-top: 0;">SYSTEM UPDATE</h2>
        <p style="color: #ccc; line-height: 1.5; font-size: 1.1em;" id="update-msg">
            A new version of the chat has been deployed.
        </p>
        <div style="margin: 20px 0; height: 1px; background: #333;"></div>
        <p style="font-size: 0.9em; color: #888;">Please acknowledge to refresh your session.</p>
        <button id="dev-ack-btn" style="margin-top: 15px; padding: 10px 25px; background: #00ACE6; border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.2s;">
            ACKNOWLEDGE & ENTER
        </button>
    </div>
</div>

<script>
    const socket = io();

    // DOM Elements
    const loginOverlay = document.getElementById('login-overlay');
    const usernameInput = document.getElementById('username-input');
    const avatarInput = document.getElementById('avatar-input');
    const joinBtn = document.getElementById('join-btn');

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    
    const userListUl = document.getElementById('user-list');
    const chatTitle = document.getElementById('chat-title');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
    const dmSidebar = document.getElementById('dm-sidebar');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');

    // Settings
    const settingsBtn = document.getElementById('settings-btn');
    const settingsDropdown = document.getElementById('settings-dropdown');
    const settingSound = document.getElementById('setting-sound');
    const settingPopup = document.getElementById('setting-popup');
    const settingTransparent = document.getElementById('setting-transparent');
    const logoutBtn = document.getElementById('logout-btn');

    // Reply Elements
    const replyBar = document.getElementById('reply-bar');
    const replyContent = document.getElementById('reply-content');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');

    // Voice Chat Elements
    const vcControls = document.getElementById('vc-controls');
    const joinVcBtn = document.getElementById('join-vc-btn');
    const leaveVcBtn = document.getElementById('leave-vc-btn');
    const muteVcBtn = document.getElementById('mute-vc-btn');
    const vcArea = document.getElementById('vc-area');
    const vcStatus = document.getElementById('vc-status');
    const vcUsersDiv = document.getElementById('vc-users');

    // Theme
    const themeToggle = document.getElementById('theme-toggle');

    // State
    let currentUsername = '';
    let stagedImage = null; // Visual preview only
    let stagedFile = null;  // RAW FILE FOR UPLOAD
    
    let currentChatMode = 'global'; // 'global' or 'dm'
    let currentDmTarget = null;
    let typingTimeout = null;
    let isTyping = false;
    let currentReplyTo = null; // Stores { id, sender, text }

    // Audio
    const notifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

    // VC State
    let localStream = null;
    let peers = {}; // connection objects
    let isMuted = false;
    let inCall = false;

    // --- INITIALIZATION ---
    // Check LocalStorage for settings
    if(localStorage.getItem('chat_theme') === 'light') document.body.classList.add('light-mode');
    if(localStorage.getItem('chat_transparent') === 'true') {
        document.body.classList.add('transparent-mode');
        settingTransparent.checked = true;
    }
    if(localStorage.getItem('chat_sound') === 'false') settingSound.checked = false;
    if(localStorage.getItem('chat_popup') === 'false') settingPopup.checked = false;

    // --- EVENT LISTENERS ---

    joinBtn.addEventListener('click', joinChat);
    usernameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') joinChat(); });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => { 
        if(e.key === 'Enter') sendMessage(); 
        handleTyping();
    });

    uploadBtn.addEventListener('click', () => hiddenFileInput.click());
    
    // NEW: HANDLE FILE SELECTION
    hiddenFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            stagedFile = file; // Store the raw file
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                stagedImage = ev.target.result; // For preview
                imagePreview.src = stagedImage;
                imagePreviewArea.style.display = 'flex';
                messageInput.focus();
            };
            reader.readAsDataURL(file);
        }
    });

    removeImageBtn.addEventListener('click', () => {
        stagedImage = null;
        stagedFile = null;
        hiddenFileInput.value = '';
        imagePreviewArea.style.display = 'none';
    });

    toggleSidebarBtn.addEventListener('click', () => {
        dmSidebar.classList.toggle('active');
    });
    closeSidebarBtn.addEventListener('click', () => {
        dmSidebar.classList.remove('active');
    });

    settingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsDropdown.classList.toggle('show');
    });
    document.addEventListener('click', () => {
        settingsDropdown.classList.remove('show');
    });
    settingsDropdown.addEventListener('click', (e) => e.stopPropagation());

    logoutBtn.addEventListener('click', () => {
        location.reload(); 
    });

    // Theme Toggle
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('chat_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    });

    // Settings Toggles
    settingSound.addEventListener('change', (e) => localStorage.setItem('chat_sound', e.target.checked));
    settingPopup.addEventListener('change', (e) => localStorage.setItem('chat_popup', e.target.checked));
    settingTransparent.addEventListener('change', (e) => {
        if(e.target.checked) document.body.classList.add('transparent-mode');
        else document.body.classList.remove('transparent-mode');
        localStorage.setItem('chat_transparent', e.target.checked);
    });

    // Reply Cancel
    cancelReplyBtn.addEventListener('click', () => {
        currentReplyTo = null;
        replyBar.style.display = 'none';
    });

    // --- FUNCTIONS ---

    function joinChat() {
        const username = usernameInput.value.trim();
        const avatarUrl = avatarInput.value.trim();
        if (username) {
            currentUsername = username;
            socket.emit('set-username', { username, avatar: avatarUrl });
            loginOverlay.style.display = 'none';
            messageInput.focus();
        }
    }

    // --- NEW SEND MESSAGE FUNCTION (WITH UPLOAD) ---
    async function sendMessage() {
        const text = messageInput.value.trim();
        
        if ((!text && !stagedFile) || !currentUsername) return;

        let finalImageUrl = null;

        // 1. UPLOAD IMAGE IF EXISTS
        if (stagedFile) {
            sendBtn.innerText = "..."; // Loading state
            const formData = new FormData();
            formData.append('image', stagedFile);

            try {
                const response = await fetch('/upload-image', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.url) {
                    finalImageUrl = data.url;
                }
            } catch (err) {
                console.error("Upload failed", err);
                alert("Image upload failed. Please try again.");
                sendBtn.innerText = "Send";
                return;
            }
        }

        const payload = { 
            text: text, 
            image: finalImageUrl, 
            replyTo: currentReplyTo 
        };

        if (currentChatMode === 'global') {
            socket.emit('chat-message', payload);
        } else {
            socket.emit('send-dm', { target: currentDmTarget, ...payload });
        }

        // RESET INPUTS
        messageInput.value = '';
        stagedImage = null;
        stagedFile = null;
        imagePreviewArea.style.display = 'none';
        hiddenFileInput.value = '';
        currentReplyTo = null;
        replyBar.style.display = 'none';
        sendBtn.innerText = "Send";

        // Stop typing
        const scope = currentChatMode === 'global' ? 'global' : currentDmTarget;
        socket.emit('typing-stop', scope);
        if (typingTimeout) clearTimeout(typingTimeout);
        isTyping = false;
    }

    function handleTyping() {
        if (!isTyping) {
            isTyping = true;
            const scope = currentChatMode === 'global' ? 'global' : currentDmTarget;
            socket.emit('typing-start', scope);
        }
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            isTyping = false;
            const scope = currentChatMode === 'global' ? 'global' : currentDmTarget;
            socket.emit('typing-stop', scope);
        }, 2000);
    }

    function appendMessage(msg) {
        // Prevent duplicates
        if (document.getElementById(`msg-${msg.id}`)) return;

        const div = document.createElement('div');
        div.id = `msg-${msg.id}`;
        div.classList.add('message');
        
        if (msg.type === 'system') div.classList.add('system-message');
        else if (msg.sender === currentUsername) div.classList.add('user-message');
        else div.classList.add('other-message');

        if (msg.type === 'pm' || msg.type === 'private') div.classList.add('pm-message');

        // Avatar
        let avatarImg = '';
        if (msg.sender !== 'System' && msg.avatar) {
            // Handle placeholder
            const src = (msg.avatar === 'placeholder-avatar.png') 
                ? 'https://ui-avatars.com/api/?name=' + msg.sender + '&background=random' 
                : msg.avatar;
            avatarImg = `<img src="${src}" class="avatar" alt="A">`;
        }

        // Reply logic
        let replyBlock = '';
        if (msg.replyTo) {
            replyBlock = `
            <div class="reply-context" onclick="scrollToMessage('${msg.replyTo.id}')">
                <strong>Replying to ${msg.replyTo.sender}:</strong> ${msg.replyTo.text || '[Image]'}
            </div>`;
        }

        // Image logic
        let imageHtml = '';
        if (msg.image) {
            imageHtml = `<img src="${msg.image}" class="message-image" onclick="window.open(this.src)">`;
        }

        // Edit tag
        let editTag = msg.isEdited ? `<span class="edit-tag">(edited)</span>` : '';

        // Content Area
        let contentHtml = `
            <div class="message-content-area">
                ${msg.sender !== 'System' ? `<div class="message-sender-name">${msg.sender}</div>` : ''}
                <div class="bubble-content">
                    ${replyBlock}
                    ${msg.text ? `<div>${linkify(msg.text)} ${editTag}</div>` : ''}
                    ${imageHtml}
                    <div class="timestamp">${msg.time}</div>
                </div>
                ${msg.sender === currentUsername ? `
                <div class="msg-actions">
                    <button onclick="editMessage('${msg.id}', '${msg.text ? msg.text.replace(/'/g, "\\'") : ''}')">‚úé</button>
                    <button onclick="deleteMessage('${msg.id}')">üóë</button>
                </div>` : `
                <div class="msg-actions">
                    <button onclick="startReply('${msg.id}', '${msg.sender}', '${msg.text ? msg.text.replace(/'/g, "\\'") : ''}')">‚Ü©</button>
                </div>
                `}
            </div>
        `;

        if (msg.sender === currentUsername) {
            div.innerHTML = `${contentHtml} ${avatarImg}`;
        } else {
            div.innerHTML = `${avatarImg} ${contentHtml}`;
        }

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        if (document.hidden && msg.sender !== currentUsername && settingPopup.checked) {
             new Notification("New Message", { body: `${msg.sender}: ${msg.text || 'Sent an image'}` });
        }
        if (msg.sender !== currentUsername && settingSound.checked) {
            notifSound.play().catch(e=>{});
        }
    }

    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            return `<a href="${url}" target="_blank" style="color: inherit; text-decoration: underline;">${url}</a>`;
        });
    }

    // --- EXPOSED ACTIONS ---
    window.startReply = (id, sender, text) => {
        currentReplyTo = { id, sender, text };
        replyContent.innerText = `Replying to ${sender}: ${text || '[Image]'}`;
        replyBar.style.display = 'flex';
        messageInput.focus();
    };

    window.scrollToMessage = (id) => {
        const el = document.getElementById(`msg-${id}`);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    window.deleteMessage = (id) => {
        if(confirm("Delete this message?")) socket.emit('delete-message', id);
    };

    window.editMessage = (id, oldText) => {
        const newText = prompt("Edit message:", oldText);
        if (newText !== null && newText !== oldText) {
            socket.emit('edit-message', { id, newText });
        }
    };

    // --- SOCKET EVENTS ---

    socket.on('history', (history) => {
        messagesDiv.innerHTML = ''; // Clear current
        history.forEach(msg => appendMessage(msg));
        const sysMsg = { type: 'system', text: 'Welcome to the chat history.', id: 'sys-history' };
        appendMessage(sysMsg);
    });

    socket.on('chat-message', (msg) => {
        if (currentChatMode === 'global') appendMessage(msg);
        else if (msg.type === 'pm' && (msg.sender === currentUsername || msg.target === currentUsername)) {
             // Optional notification for PM while in DM mode
        }
    });

    socket.on('message-deleted', (id) => {
        const el = document.getElementById(`msg-${id}`);
        if (el) {
            el.style.opacity = '0.5';
            el.innerHTML = '<span style="font-style:italic; color:#888;">Message deleted</span>';
        }
    });

    socket.on('message-updated', (data) => {
        const el = document.getElementById(`msg-${data.id}`);
        if (el) {
            const bubble = el.querySelector('.bubble-content div');
            if(bubble) bubble.innerHTML = `${linkify(data.text)} <span class="edit-tag">(edited)</span>`;
        }
    });

    // Sidebar & DM Logic
    socket.on('sidebar-user-list', (users) => {
        // Sort: Online first, then alphabetical
        users.sort((a,b) => (b.online - a.online) || a.username.localeCompare(b.username));
        
        userListUl.innerHTML = '';
        // Add Global Chat Item
        const globalLi = document.createElement('li');
        globalLi.className = (currentChatMode === 'global') ? 'active-chat' : '';
        globalLi.innerHTML = `<span>üåê Global Chat</span>`;
        globalLi.onclick = () => switchChat('global');
        userListUl.appendChild(globalLi);

        users.forEach(u => {
            if (u.username === currentUsername) return; // Don't show self
            const li = document.createElement('li');
            const statusColor = u.online ? '#4caf50' : '#888';
            li.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="width:10px; height:10px; border-radius:50%; background:${statusColor}"></div>
                    <span>${u.username}</span>
                </div>
            `;
            if (currentChatMode === 'dm' && currentDmTarget === u.username) li.classList.add('active-chat');
            
            li.onclick = () => switchChat('dm', u.username);
            userListUl.appendChild(li);
        });
    });

    function switchChat(mode, target = null) {
        currentChatMode = mode;
        currentDmTarget = target;
        messagesDiv.innerHTML = ''; // Clear view
        
        // Update Sidebar UI
        document.querySelectorAll('#user-list li').forEach(li => li.classList.remove('active-chat'));
        // (Re-rendering sidebar would handle highlight, but for instant feedback:)
        
        if (mode === 'global') {
            chatTitle.innerText = "Global Chat";
            socket.emit('get-history'); // Reload global history
        } else {
            chatTitle.innerText = `Chat with ${target}`;
            socket.emit('fetch-dm-history', target);
        }
        
        // Close sidebar on mobile
        if(window.innerWidth < 768) dmSidebar.classList.remove('active');
    }

    socket.on('dm-history', (data) => {
        if (currentChatMode === 'dm' && currentDmTarget === data.target) {
            data.messages.forEach(msg => appendMessage(msg));
        }
    });

    socket.on('dm-received', (data) => {
        // If we are looking at this chat, show it
        if (currentChatMode === 'dm' && (currentDmTarget === data.from || (data.from === currentUsername && currentDmTarget === data.to))) {
            appendMessage(data.message);
        } else {
            // Notification logic could go here (e.g., highlight sidebar)
            if(settingSound.checked) notifSound.play().catch(e=>{});
        }
    });

    socket.on('motd', (msg) => {
        const div = document.createElement('div');
        div.style.textAlign = 'center';
        div.style.color = 'var(--color-system)';
        div.style.margin = '10px 0';
        div.style.fontSize = '0.9em';
        div.innerText = `MOTD: ${msg}`;
        messagesDiv.appendChild(div);
    });

    // Typing Indicators
    const typingDiv = document.getElementById('typing-indicator');
    socket.on('user-typing', (data) => {
        if (data.scope === 'global' && currentChatMode === 'global') {
            typingDiv.innerText = `${data.username} is typing...`;
            typingDiv.style.display = 'block';
        } else if (data.scope === 'dm' && currentChatMode === 'dm' && currentDmTarget === data.username) {
            typingDiv.innerText = `${data.username} is typing...`;
            typingDiv.style.display = 'block';
        }
    });
    socket.on('user-stopped-typing', (data) => {
        typingDiv.style.display = 'none';
    });
    socket.on('clear-chat', () => {
        messagesDiv.innerHTML = '';
        appendMessage({type:'system', text:'Chat history has been cleared by an admin.'});
    });


    // --- UPDATE NOTIFICATION LOGIC ---
    (function() {
        const modal = document.getElementById('dev-modal');
        const btn = document.getElementById('dev-ack-btn');
        const msgPara = document.getElementById('update-msg');
        let currentServerId = null;

        if (typeof socket !== 'undefined') {
            socket.on('system-version-check', (data) => {
                const serverId = data.id || data;
                const description = data.description || "A new update has been deployed.";
                currentServerId = serverId;
                if(msgPara) msgPara.innerText = description;
                checkVersion(serverId);
            });
        }

        function checkVersion(serverId) {
            const lastSeenVersion = localStorage.getItem('agreed_build_version');
            if (lastSeenVersion != serverId) {
                modal.style.display = 'flex';
            }
        }

        btn.onclick = function() {
            modal.style.display = 'none';
            if (currentServerId) {
                localStorage.setItem('agreed_build_version', currentServerId);
            }
        };
        
        btn.onmouseover = () => btn.style.backgroundColor = '#008bb5';
        btn.onmouseout = () => btn.style.backgroundColor = '#00ACE6';
    })();


    // --- VOICE CHAT LOGIC (SIMPLE MESH) ---
    // Note: For production, use WebRTC PeerConnection. This is a placeholder for socket-event signaling.
    
    joinVcBtn.addEventListener('click', () => {
        socket.emit('vc-join');
        vcArea.style.display = 'block';
        joinVcBtn.classList.add('hidden');
        leaveVcBtn.classList.remove('hidden');
        muteVcBtn.classList.remove('hidden');
        vcStatus.innerText = "Connected to Voice";
    });

    leaveVcBtn.addEventListener('click', () => {
        socket.emit('vc-leave');
        vcArea.style.display = 'none';
        joinVcBtn.classList.remove('hidden');
        leaveVcBtn.classList.add('hidden');
        muteVcBtn.classList.add('hidden');
        vcUsersDiv.innerHTML = '';
    });

    muteVcBtn.addEventListener('click', () => {
        isMuted = !isMuted;
        muteVcBtn.innerText = isMuted ? "Unmute" : "Mute";
        muteVcBtn.style.backgroundColor = isMuted ? "#d32f2f" : "#444";
        socket.emit('vc-mute-toggle', isMuted);
    });

    socket.on('vc-user-list-update', (users) => {
        vcUsersDiv.innerHTML = '';
        users.forEach(u => {
            const d = document.createElement('div');
            d.className = 'vc-user';
            d.innerHTML = `
                <img src="${u.avatar || 'placeholder-avatar.png'}" width="30" height="30" style="border-radius:50%">
                <span>${u.username}</span>
                ${u.isMuted ? 'üé§‚ùå' : 'üé§'}
            `;
            vcUsersDiv.appendChild(d);
        });
    });

</script>
</body>
</html>
