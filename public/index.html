<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat App</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="chat-container">
        <div id="username-area">
            <button id="avatar-upload-btn"><img id="current-avatar-preview" src="placeholder-avatar.png"></button>
            <h3>username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>
        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list"></ul>
        </div>
        <div id="messages"></div>
        <div id="message-input-area">
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        <h4 class="panel-title">voice chat</h4>
        <button id="vc-btn-join" class="panel-btn">Join Call</button>
        <button id="vc-btn-mute" class="panel-btn" style="display: none;">Mute</button>
        <ul id="vc-user-list"></ul>
        <div id="audio-grid" style="display:none;"></div>
    </div>
</div>

<script>
    const socket = io();
    const myPeer = new Peer(undefined, {
        host: '/',
        port: 443, // Render uses 443 for HTTPS
        path: '/peerjs' // PeerJS cloud default fallback, or we can use the cloud
    }); 
    
    // NOTE: If the PeerJS server above fails on Render, switch to the free public cloud:
    // const myPeer = new Peer(); 

    const peers = {}; // Keep track of active calls
    let myLocalStream;
    let isInVC = false;

    // --- DOM Elements ---
    const messagesDiv = document.getElementById('messages');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const vcBtnJoin = document.getElementById('vc-btn-join');
    const vcBtnMute = document.getElementById('vc-btn-mute');
    const vcUserList = document.getElementById('vc-user-list');
    const audioGrid = document.getElementById('audio-grid');
    
    let currentUsername = localStorage.getItem('chatUsername') || '';
    let currentAvatar = localStorage.getItem('chatAvatar') || '';

    // --- Setup Username ---
    if (currentUsername) {
        usernameInput.value = currentUsername;
        document.getElementById('current-avatar-preview').src = currentAvatar || 'placeholder-avatar.png';
        socket.emit('set-username', { username: currentUsername, avatar: currentAvatar });
        usernameInput.disabled = true; setUsernameBtn.disabled = true;
    }

    setUsernameBtn.addEventListener('click', () => {
        currentUsername = usernameInput.value.trim();
        if (currentUsername) {
            localStorage.setItem('chatUsername', currentUsername);
            socket.emit('set-username', { username: currentUsername, avatar: currentAvatar });
            usernameInput.disabled = true; setUsernameBtn.disabled = true;
        }
    });

    // --- Chat Logic ---
    sendButton.addEventListener('click', () => {
        const msg = messageInput.value.trim();
        if(msg) { socket.emit('chat-message', msg); messageInput.value = ''; }
    });
    
    socket.on('chat-message', (msg) => {
        const div = document.createElement('div');
        div.className = msg.sender === currentUsername ? 'message user-message' : 'message other-message';
        // Simplified display for brevity
        div.innerHTML = `<span class="bubble-content" style="background:${msg.sender===currentUsername?'#007acc':'#3c3c3c'}; padding:8px; border-radius:8px;">
            ${msg.sender !== currentUsername ? '<b>'+msg.sender+': </b>' : ''}${msg.text}
        </span>`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // --- INSTANT VOICE CHAT LOGIC (WebRTC) ---

    // 1. PeerJS Open (We got a Peer ID)
    myPeer.on('open', id => {
        console.log('My Peer ID is: ' + id);
    });

    // 2. Button Handler
    vcBtnJoin.addEventListener('click', () => {
        if (!currentUsername) return alert("Set username first!");
        
        if (!isInVC) {
            joinVoiceChat();
        } else {
            leaveVoiceChat();
        }
    });

    function joinVoiceChat() {
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            .then(stream => {
                myLocalStream = stream;
                isInVC = true;
                
                // UI Updates
                vcBtnJoin.textContent = 'Leave Call';
                vcBtnJoin.style.backgroundColor = '#dc3545';
                vcBtnMute.style.display = 'block';

                // Tell Server we joined with our Peer ID
                socket.emit('join-vc', myPeer.id);

                // Answer calls from others
                myPeer.on('call', call => {
                    call.answer(stream); // Send them our stream
                    const audio = document.createElement('audio');
                    
                    call.on('stream', userAudioStream => {
                        addAudioStream(audio, userAudioStream);
                    });
                });

                // Listen for new users connecting
                socket.on('user-connected', ({ peerId, socketId }) => {
                    // Call the new user
                    connectToNewUser(peerId, stream);
                });
            })
            .catch(err => {
                console.error("Mic Error:", err);
                alert("Could not access microphone.");
            });
    }

    function connectToNewUser(peerId, stream) {
        // Call them
        const call = myPeer.call(peerId, stream);
        const audio = document.createElement('audio');
        
        call.on('stream', userAudioStream => {
            addAudioStream(audio, userAudioStream);
        });
        
        call.on('close', () => {
            audio.remove();
        });

        peers[peerId] = call;
    }

    function addAudioStream(audio, stream) {
        audio.srcObject = stream;
        audio.addEventListener('loadedmetadata', () => {
            audio.play();
        });
        audioGrid.append(audio);
    }

    function leaveVoiceChat() {
        isInVC = false;
        socket.emit('leave-vc');
        
        // Kill local mic
        if (myLocalStream) {
            myLocalStream.getTracks().forEach(track => track.stop());
            myLocalStream = null;
        }

        // Close all peer connections
        Object.keys(peers).forEach(key => {
            if (peers[key]) peers[key].close();
        });

        // UI Reset
        vcBtnJoin.textContent = 'Join Call';
        vcBtnJoin.style.backgroundColor = '#007acc';
        vcBtnMute.style.display = 'none';
        audioGrid.innerHTML = ''; // Clear audio elements
    }

    // Handle user disconnecting
    socket.on('user-disconnected', peerId => {
        if (peers[peerId]) peers[peerId].close();
    });

    // Mute Logic
    vcBtnMute.addEventListener('click', () => {
        if (myLocalStream) {
            const track = myLocalStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            vcBtnMute.textContent = track.enabled ? 'Mute' : 'Unmute';
            vcBtnMute.classList.toggle('active', !track.enabled);
            socket.emit('vc-mute-toggle', !track.enabled);
        }
    });

    // --- Lists ---
    socket.on('vc-user-list-update', list => {
        vcUserList.innerHTML = '';
        list.forEach(u => {
            const li = document.createElement('li');
            li.innerHTML = `${u.username} ${u.isMuted ? 'ðŸ”‡' : ''}`;
            li.style.color = '#4caf50';
            vcUserList.appendChild(li);
        });
    });

    socket.on('user-list-update', list => {
        const ul = document.getElementById('online-users-list');
        ul.innerHTML = '';
        list.forEach(u => {
            const li = document.createElement('li');
            li.textContent = u.username;
            ul.appendChild(li);
        });
    });

</script>
</body>
</html>
