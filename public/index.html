<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat App</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="chat-container">
        <div id="username-area">
            <h3>username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list">
                </ul>
        </div>
        
        <div id="messages">
            </div>

        <div id="message-input-area">
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <button id="file-upload-btn" title="File Upload (Not implemented)">
                üìÅ
            </button>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        <h3 class="panel-title">Settings</h3>

        <div>
            <button id="bg-upload-btn" class="panel-btn">Upload Background</button>
            <input type="file" id="bg-file-input" accept="image/*" style="display: none;">
            <p class="panel-hint">Select a local image (JPG, PNG, GIF).</p>
        </div>
        
        <h3 class="panel-title">Window</h3>
        <button id="launch-custom-window-btn" class="panel-btn">Launch Chat Window</button>
        <p class="panel-hint">Opens the chat in a new resizable window.</p>
    </div>

</div>

<script>
    const socket = io();

    // --- UI Element Selectors ---
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const onlineUsersList = document.getElementById('online-users-list');
    const launchCustomWindowBtn = document.getElementById('launch-custom-window-btn');
    // New Selectors
    const bgUploadBtn = document.getElementById('bg-upload-btn');
    const bgFileInput = document.getElementById('bg-file-input');

    // --- State Variables ---
    let currentUsername = 'Anonymous';
    let lastUserMessageTime = 0; // Timestamp of the last message sent by the current user
    let lastOtherMessageSender = ''; // Username of the last message sent by another user

    // --- Utility: Message Grouping ---

    /**
     * Parses and displays a single formatted message, handling grouping and styling.
     * @param {string} formattedMessage - The server-sent message string.
     */
    function displayMessage(formattedMessage) {
        // 1. Parse the message content
        // Regex to extract [Username/System/Announcement]: Message Content [Time]
        const match = formattedMessage.match(/(\*\*.*?\*\*): (.*?) \[(.*?)\]/) ||
                      formattedMessage.match(/(\*\*.*?\*\*) (.*?) \[(.*?)\]/);
        
        // System/Announcement messages
        let sender = 'System';
        let text = formattedMessage;
        let time = '';
        let messageType = 'system-message';
        let rawUsername = '';

        if (match) {
            rawUsername = match[1].replace(/\*\*/g, ''); // e.g., 'Announcement' or 'User1'
            text = match[2];
            time = match[3];
            
            if (rawUsername === 'System') {
                messageType = 'system-message';
                sender = 'System';
            } else if (rawUsername === 'Announcement') {
                messageType = 'system-message'; 
                sender = 'Announcement';
            } else {
                sender = rawUsername;
                messageType = (sender === currentUsername) ? 'user-message' : 'other-message';
            }
        } else {
            // Fallback for unexpected format (treated as a system message)
            console.warn('Message format mismatch:', formattedMessage);
        }
        
        const messageEl = document.createElement('div');
        messageEl.classList.add('message', messageType);

        // Get current time in milliseconds for grouping logic
        const currentTimeMs = new Date().getTime();
        const isCurrentUser = (sender === currentUsername);

        // --- Message Grouping Logic ---
        let shouldGroup = false;

        if (isCurrentUser) {
            // Group consecutive user messages if sent within 60 seconds
            if (currentTimeMs - lastUserMessageTime < 60000) {
                shouldGroup = true;
            }
            lastUserMessageTime = currentTimeMs;
            lastOtherMessageSender = ''; // Reset other sender tracker
        } else if (messageType === 'other-message') {
            // Group consecutive other-user messages from the same sender
            if (sender === lastOtherMessageSender) {
                shouldGroup = true;
            }
            lastOtherMessageSender = sender;
            lastUserMessageTime = 0; // Reset user time tracker
        } else {
            // System/Announcement messages reset grouping
            lastUserMessageTime = 0;
            lastOtherMessageSender = '';
        }

        if (shouldGroup) {
            messageEl.classList.add('grouped-message');
        }

        // --- Message Content Construction ---

        // 1. Username (for other-messages only, and only if not grouped)
        if (messageType === 'other-message' && !shouldGroup) {
            const usernameSpan = document.createElement('p');
            usernameSpan.classList.add('message-username');
            usernameSpan.innerHTML = `<strong>${sender}</strong><span class="username-separator">:</span>`;
            messageEl.appendChild(usernameSpan);
        }

        // 2. Content Wrapper (holds the bubble and the timestamp)
        const contentWrapper = document.createElement('div');
        contentWrapper.classList.add('message-content-wrapper');

        // 3. The Bubble Content
        const bubbleContent = document.createElement('div');
        bubbleContent.classList.add('bubble-content');
        
        // For System/Announcement messages, use the full text
        if (messageType === 'system-message') {
            // The server format for system messages already includes the time, so we just wrap it.
            bubbleContent.innerHTML = formattedMessage;
            messageEl.appendChild(bubbleContent);
        } else {
            // For regular messages, insert the text
            bubbleContent.textContent = text;
            contentWrapper.appendChild(bubbleContent);

            // 4. Timestamp
            const timeSpan = document.createElement('p');
            timeSpan.classList.add('message-time');
            timeSpan.textContent = time;
            contentWrapper.appendChild(timeSpan);
            
            messageEl.appendChild(contentWrapper);
        }
        
        // Final Append and Scroll
        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 
    }


    // --- Event Handlers ---

    // 1. Set Username Handler
    setUsernameBtn.addEventListener('click', () => {
        const newUsername = usernameInput.value.trim();
        if (newUsername && newUsername !== currentUsername) {
            socket.emit('set-username', newUsername);
            currentUsername = newUsername; // Optimistically update client state
        }
    });

    // 2. Send Message Handler
    sendButton.addEventListener('click', () => {
        const msg = messageInput.value.trim();
        if (msg) {
            socket.emit('chat-message', msg);
            messageInput.value = ''; // Clear the input after sending
            // Reset lastOtherMessageSender because the next message will be 'user-message'
            lastOtherMessageSender = '';
        }
    });

    // Allow sending with Enter key, but use Shift+Enter for new line
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent new line
            sendButton.click();
        }
    });

    // --- NEW: Background Upload Logic ---

    // 3. Button Click: Triggers the hidden file input
    bgUploadBtn.addEventListener('click', () => {
        bgFileInput.click();
    });

    // 4. File Input Change: Handles the selected file
    bgFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];

        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();

            reader.onload = (event) => {
                const dataUrl = event.target.result;
                // Set the body's background directly using the loaded data URL
                document.body.style.background = `url(${dataUrl}) center center / cover no-repeat, var(--bg-primary)`;
            };

            reader.readAsDataURL(file); // Read the file as a data URL (Base64 string)
        } else if (file) {
            alert("Please select a valid image file.");
        }
        // Clear the input value so the 'change' event fires again if the user selects the same file
        e.target.value = null; 
    });


    // --- Socket Listeners ---

    // 5. Initial History Load and Chat Message Display
    socket.on('history', (history) => {
        // Reset trackers before starting the loop
        lastUserMessageTime = 0; 
        lastOtherMessageSender = ''; 
        messagesDiv.innerHTML = ''; 

        // Loop through history messages sequentially
        history.forEach(msg => {
            displayMessage(msg);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 
    });

    socket.on('chat-message', (formattedMessage) => {
        displayMessage(formattedMessage);
    });

    socket.on('clear-chat', () => {
        messagesDiv.innerHTML = '';
    });

    // 6. Online User List Update
    socket.on('user-list-update', (users) => {
        onlineUsersList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user;
            onlineUsersList.appendChild(li);
        });
    });

    // 7. Launch Custom Window Logic
    if (launchCustomWindowBtn) {
         launchCustomWindowBtn.addEventListener('click', () => {
            // Get the current URL root (removing any existing query params)
            const currentUrl = window.location.href.split('?')[0]; 
            // Add the new popup flag to the URL
            const newUrl = `${currentUrl}?mode=popup`; 
            
            // Open a new window with the specific query parameter
            window.open(newUrl, '_blank', 'width=400,height=600,resizable=yes');
        });
    }
</script>


</body>
</html>
