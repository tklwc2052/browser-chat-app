<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="chat-container">
        <div id="username-area">
            <button id="avatar-upload-btn" title="Set Avatar">
                <img id="current-avatar-preview" src="placeholder-avatar.png" alt="Avatar">
            </button>
            <h3>username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list"></ul>
        </div>
        
        <div id="messages"></div>

        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>
            
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
            
            <button id="file-upload-btn" title="Upload Image">üìÅ</button>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        <div class="panel-top-group">
            <div>
                <h4 class="panel-title">other stuff</h4>
                <button id="launch-custom-window-btn" class="panel-btn">resizable window</button>
            </div>

            <div>
                <h4 class="panel-title">voice chat</h4>
                <button id="vc-btn-join" class="panel-btn">Join Call</button>
                <button id="vc-btn-mute" class="panel-btn" style="display: none;">Mute</button>
                <ul id="vc-user-list"></ul>
                <div id="audio-container" style="display:none;"></div>
            </div>
        </div>

        <div class="panel-bottom-group">
            <h4 class="panel-title">Browser</h4>
            <button id="btn-cloak-launcher" class="panel-btn">Launch New Tab</button>
            <div style="margin-bottom: 15px;"></div> 

            <h4 class="panel-title">Appearance</h4>
            <div class="settings-panel">
                <ul class="settings-list">
                    <li class="setting-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size:0.9em; color:#aaa;">Custom BG</span>
                            <div style="display: flex; gap: 5px;">
                                <button id="btn-bg-upload" class="panel-btn" style="font-size: 0.8em; margin: 0; width: auto; padding: 4px 8px;">Upload</button>
                                <button id="btn-bg-reset" class="panel-btn" style="font-size: 0.8em; margin: 0; width: auto; padding: 4px 8px; background-color: var(--color-vc-red);">Reset</button>
                            </div>
                        </div>
                        <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">
                    </li>
                </ul>
            </div>

            <div class="dropdown-wrapper">
                <div class="dropdown-header" id="notif-dropdown-header">
                    <span>Notifications</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="dropdown-content" id="notif-dropdown-content">
                    <ul class="settings-list">
                        <li class="setting-item">
                            <span>Main Messages</span>
                            <input type="checkbox" id="setting-main" checked>
                        </li>
                        <li class="setting-item">
                            <span>Private Messages</span>
                            <input type="checkbox" id="setting-pm" checked>
                        </li>
                        <li class="setting-item">
                            <span>Sound</span>
                            <input type="checkbox" id="setting-sound" checked>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();

    // DOM Elements
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const onlineUsersList = document.getElementById('online-users-list');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');
    const typingIndicator = document.getElementById('typing-indicator');

    // Settings Elements
    const settingMain = document.getElementById('setting-main');
    const settingPM = document.getElementById('setting-pm');
    const settingSound = document.getElementById('setting-sound');
    const btnBgUpload = document.getElementById('btn-bg-upload');
    const btnBgReset = document.getElementById('btn-bg-reset');
    const bgUploadInput = document.getElementById('bg-upload-input');
    
    // Dropdown Elements
    const notifHeader = document.getElementById('notif-dropdown-header');
    const notifContent = document.getElementById('notif-dropdown-content');

    let currentUsername = '';
    let currentAvatarBase64 = ''; 
    let stagedImage = null; 
    let typingTimeout;

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        const storedUsername = localStorage.getItem('chatUsername');
        const storedAvatar = localStorage.getItem('chatAvatar');
        
        if (storedAvatar) { 
            currentAvatarBase64 = storedAvatar; 
            currentAvatarPreview.src = storedAvatar; 
        }

        if (storedUsername) { 
            usernameInput.value = storedUsername; 
            joinChat(); 
        }

        // Load Background
        const savedBg = localStorage.getItem('custom-bg');
        if (savedBg) {
            document.body.style.backgroundImage = `url(${savedBg})`;
            document.body.classList.add('transparent-mode');
        }
    });

    // --- USERNAME LOGIC ---
    function joinChat() {
        const username = usernameInput.value.trim();
        if (username) {
            currentUsername = username;
            localStorage.setItem('chatUsername', currentUsername);
            socket.emit('set-username', { username: currentUsername, avatar: currentAvatarBase64 || 'placeholder-avatar.png' });
            
            document.getElementById('username-area').innerHTML = `<h3>Logged in as: <span style="color:var(--color-accent-green);">${username}</span></h3>`;
        }
    }
    setUsernameBtn.addEventListener('click', joinChat);

    // --- AVATAR UPLOAD ---
    avatarUploadBtn.addEventListener('click', () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    currentAvatarBase64 = reader.result;
                    currentAvatarPreview.src = currentAvatarBase64;
                    localStorage.setItem('chatAvatar', currentAvatarBase64);
                    // Update server if already logged in
                    if(currentUsername) socket.emit('set-username', { username: currentUsername, avatar: currentAvatarBase64 });
                };
                reader.readAsDataURL(file);
            }
        });
        fileInput.click();
    });

    // --- MESSAGE HANDLING ---
    socket.on('chat-message', (msg) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        
        const isMe = (msg.sender === currentUsername);
        if (isMe) messageElement.classList.add('user-message');
        else messageElement.classList.add('other-message');

        if (msg.type === 'system') {
            messageElement.classList.remove('user-message', 'other-message');
            messageElement.classList.add('system-message');
            messageElement.innerHTML = `<div class="bubble-content" style="background:none; color: var(--color-system); text-align:center; width:100%;">${msg.text}</div>`;
        } else {
            // Avatar (Left side for others)
            if (!isMe && msg.avatar) {
                const avatarImg = document.createElement('img');
                avatarImg.classList.add('avatar');
                avatarImg.src = msg.avatar;
                messageElement.appendChild(avatarImg);
            }

            const contentArea = document.createElement('div');
            contentArea.classList.add('message-content-area');

            // Username (only for others)
            if (!isMe) {
                const userDiv = document.createElement('div');
                userDiv.classList.add('message-username');
                userDiv.innerText = msg.sender;
                contentArea.appendChild(userDiv);
            }

            // Bubble
            const bubble = document.createElement('div');
            bubble.classList.add('bubble-content');
            
            // Image in message
            if (msg.image) {
                const imgEl = document.createElement('img');
                imgEl.src = msg.image;
                imgEl.classList.add('message-image');
                imgEl.onclick = () => {
                    const win = window.open();
                    win.document.write(`<img src="${msg.image}" style="max-width:100%;">`);
                };
                bubble.appendChild(imgEl);
            }

            // Text in message
            if (msg.text) {
                const textSpan = document.createElement('div');
                textSpan.innerHTML = formatText(msg.text);
                bubble.appendChild(textSpan);
            }

            // Timestamp
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.innerText = msg.time;

            contentArea.appendChild(bubble);
            contentArea.appendChild(timeDiv);
            messageElement.appendChild(contentArea);
        }

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Sound/Notification
        if (!isMe && msg.type !== 'system') {
            if (settingSound.checked && !document.hidden) playSound();
            if (document.hidden && settingMain.checked) {
                new Notification(`New message from ${msg.sender}`, { body: msg.text || "Sent an image" });
            }
        }
    });

    socket.on('history', (history) => {
        messagesDiv.innerHTML = '';
        history.forEach(msg => {
            // Manually trigger the chat-message logic for history
            socket.listeners('chat-message')[0](msg);
        });
    });

    // --- SENDING MESSAGES ---
    function sendMessage() {
        const text = messageInput.value.trim();
        if ((text || stagedImage) && currentUsername) {
            socket.emit('chat-message', { 
                text: text, 
                image: stagedImage 
            });
            messageInput.value = '';
            
            // Clear Image Staging
            stagedImage = null;
            imagePreviewArea.style.display = 'none';
            hiddenFileInput.value = ''; // Reset file input
            
            socket.emit('typing-stop');
        }
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // --- FILE UPLOAD (GIF FIX IS HERE) ---
    function resizeImage(file, maxWidth, maxHeight, quality, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width, height = img.height;
                if (width > height) {
                    if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                } else {
                    if (height > maxHeight) { width = Math.round(width * (maxHeight / height)); height = maxHeight; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', quality));
            };
        };
    }

    function handleFileSelection(file) {
        if (!file || !file.type.startsWith('image/')) return;

        // --- GIF FIX: Do not resize GIFs! ---
        if (file.type === 'image/gif') {
            const reader = new FileReader();
            reader.onload = (e) => {
                stagedImage = e.target.result; // Use raw GIF data
                imagePreview.src = stagedImage;
                imagePreviewArea.style.display = 'flex';
            };
            reader.readAsDataURL(file);
            return; // Stop here
        }
        // ------------------------------------

        // Resize other images (JPG/PNG)
        resizeImage(file, 800, 800, 0.7, (resizedDataUrl) => {
            stagedImage = resizedDataUrl;
            imagePreview.src = stagedImage;
            imagePreviewArea.style.display = 'flex';
        });
    }

    fileUploadBtn.addEventListener('click', () => hiddenFileInput.click());
    hiddenFileInput.addEventListener('change', (e) => handleFileSelection(e.target.files[0]));
    
    // Paste Support
    window.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                handleFileSelection(item.getAsFile());
            }
        }
    });

    removeImageBtn.addEventListener('click', () => {
        stagedImage = null;
        imagePreviewArea.style.display = 'none';
        hiddenFileInput.value = '';
    });

    // --- TYPING INDICATOR ---
    messageInput.addEventListener('input', () => {
        socket.emit('typing-start');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => socket.emit('typing-stop'), 1000);
    });

    socket.on('user-typing', (username) => {
        typingIndicator.innerText = `${username} is typing...`;
        typingIndicator.style.opacity = '1';
    });

    socket.on('user-stopped-typing', () => {
        typingIndicator.style.opacity = '0';
    });

    // --- ONLINE USERS ---
    socket.on('update-user-list', (users) => {
        onlineUsersList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="user-status-dot online"></div>
                <img src="${user.avatar || 'placeholder-avatar.png'}" style="width:20px; height:20px; border-radius:50%; margin-right:5px; vertical-align:middle;">
                ${user.username}
            `;
            onlineUsersList.appendChild(li);
        });
    });

    // --- SETTINGS: BACKGROUND ---
    btnBgUpload.addEventListener('click', () => bgUploadInput.click());
    
    bgUploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bgData = evt.target.result;
                localStorage.setItem('custom-bg', bgData);
                document.body.style.backgroundImage = `url(${bgData})`;
                document.body.classList.add('transparent-mode');
            };
            reader.readAsDataURL(file);
        }
    });

    btnBgReset.addEventListener('click', () => {
        localStorage.removeItem('custom-bg');
        document.body.style.backgroundImage = '';
        document.body.classList.remove('transparent-mode');
    });

    // --- SETTINGS: SOUND & NOTIFS ---
    function playSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(440, ctx.currentTime);
        gain.gain.setValueAtTime(0.05, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
    }

    if (Notification.permission === 'default') Notification.requestPermission();

    // Dropdown toggle
    notifHeader.addEventListener('click', () => {
        notifHeader.classList.toggle('active');
        notifContent.classList.toggle('show');
    });

    // --- UTILS ---
    function formatText(text) {
        let safeText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
        safeText = safeText.replace(urlRegex, url => `<a href="${url}" target="_blank" style="color: #4da6ff; text-decoration: underline;">${url}</a>`);
        return safeText
            .replace(/~~(.*?)~~/g, '<del>$1</del>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }

    // --- VC LOGIC (PRESERVED) ---
    const vcBtnJoin = document.getElementById('vc-btn-join');
    const vcBtnMute = document.getElementById('vc-btn-mute');
    const vcUserList = document.getElementById('vc-user-list');
    const audioContainer = document.getElementById('audio-container');
    
    let localStream;
    let peers = {};
    let isMuted = false;

    vcBtnJoin.addEventListener('click', () => {
        if (!localStream) startVC();
        else leaveVC();
    });

    vcBtnMute.addEventListener('click', () => {
        if (localStream) {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            vcBtnMute.innerText = isMuted ? "Unmute" : "Mute";
            vcBtnMute.style.backgroundColor = isMuted ? "var(--color-vc-red)" : "";
            socket.emit('vc-mute-toggle', isMuted);
        }
    });

    async function startVC() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            vcBtnJoin.innerText = "Leave Call";
            vcBtnJoin.classList.add('active');
            vcBtnMute.style.display = 'inline-block';
            socket.emit('join-vc');
        } catch (err) {
            alert("Could not access microphone.");
        }
    }

    function leaveVC() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        Object.values(peers).forEach(peer => peer.close());
        peers = {};
        
        vcBtnJoin.innerText = "Join Call";
        vcBtnJoin.classList.remove('active');
        vcBtnMute.style.display = 'none';
        socket.emit('leave-vc');
    }

    socket.on('vc-update', (users) => {
        vcUserList.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.style.color = u.isMuted ? 'var(--color-vc-red)' : 'var(--color-accent-green)';
            li.innerText = u.username + (u.isMuted ? " (Muted)" : "");
            vcUserList.appendChild(li);

            // WebRTC Connection Logic (Simplified for brevity in this fix)
            if (u.id !== socket.id && !peers[u.id] && localStream) {
                const peer = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                peers[u.id] = peer;
                
                localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
                peer.onicecandidate = e => { if(e.candidate) socket.emit('signal', { target: u.id, signal: e.candidate }); };
                peer.ontrack = e => {
                    const audio = document.createElement('audio');
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                    audioContainer.appendChild(audio);
                };
                
                peer.createOffer().then(offer => peer.setLocalDescription(offer)).then(() => {
                    socket.emit('signal', { target: u.id, signal: peer.localDescription });
                });
            }
        });
    });

    socket.on('signal', async (data) => {
        if (!localStream) return;
        const peer = peers[data.sender] || new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        peers[data.sender] = peer;

        if (data.signal.type === 'offer') {
            await peer.setRemoteDescription(new RTCSessionDescription(data.signal));
            localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);
            socket.emit('signal', { target: data.sender, signal: answer });
            
            peer.ontrack = e => {
                const audio = document.createElement('audio');
                audio.srcObject = e.streams[0];
                audio.autoplay = true;
                audioContainer.appendChild(audio);
            };
        } else if (data.signal.type === 'answer') {
            await peer.setRemoteDescription(new RTCSessionDescription(data.signal));
        } else if (data.signal.candidate) {
            await peer.addIceCandidate(new RTCIceCandidate(data.signal));
        }
    });

    // --- CLOAK LAUNCHER ---
    const btnCloakLauncher = document.getElementById('btn-cloak-launcher');
    const chromeIconSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%234caf50' d='M24 5c10.493 0 19 8.507 19 19s-8.507 19-19 19-19-8.507-19-19S13.507 5 24 5m0-2C12.402 3 3 12.402 3 24s9.402 21 21 21 21-9.402 21-21S35.598 3 24 3z'/%3E%3C/svg%3E`;

    if (btnCloakLauncher) {
        btnCloakLauncher.addEventListener('click', () => {
            const urlToEmbed = "https://tuff.speedslicer.dev/files/1_1UT8/WASM/";
            const newWindow = window.open('about:blank', '_blank');

            if (!newWindow) {
                btnCloakLauncher.innerText = "Blocked!";
                btnCloakLauncher.style.backgroundColor = "var(--color-vc-red)";
                setTimeout(() => {
                    btnCloakLauncher.innerText = "Launch New Tab";
                    btnCloakLauncher.style.backgroundColor = ""; 
                }, 2000);
                return;
            }

            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>New Tab</title> 
                    <link rel="icon" type="image/svg+xml" href="${chromeIconSvg}">
                    <style>
                        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; }
                        iframe { border: none; width: 100vw; height: 100vh; display: block; }
                    </style>
                </head>
                <body>
                    <iframe src="${urlToEmbed}" title="Embedded Content"></iframe>
                </body>
                </html>
            `;
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        });
    }
</script>
</body>
</html>
