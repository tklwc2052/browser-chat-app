<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="whiteboard-panel">
        <div class="panel-header">
            <span>üé® Board</span>
            <div class="wb-controls">
                <input type="color" id="wb-color" value="#ffffff" title="Brush Color">
                <input type="range" id="wb-size" min="1" max="20" value="3" title="Brush Size">
                <button id="wb-clear-btn" style="background:none;border:none;cursor:pointer;">üóë</button>
            </div>
        </div>
        <div id="canvas-container">
            <canvas id="whiteboard"></canvas>
        </div>
    </div>

    <div id="chat-container">
        <div id="username-area">
            <button id="avatar-upload-btn" title="Set Avatar">
                <img id="current-avatar-preview" src="placeholder-avatar.png" alt="Avatar">
            </button>
            <h3>username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list"></ul>
        </div>
        
        <div id="messages"></div>
        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
            <button id="file-upload-btn" title="Upload Image">üìÅ</button>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        <div class="panel-top-group">
            <div>
                <h4 class="panel-title">other stuff</h4>
                <button id="launch-custom-window-btn" class="panel-btn">resizable window</button>
            </div>

            <div>
                <h4 class="panel-title">voice chat</h4>
                <button id="vc-btn-join" class="panel-btn">Join Call</button>
                <button id="vc-btn-mute" class="panel-btn" style="display: none;">Mute</button>
                <ul id="vc-user-list"></ul>
                <div id="audio-container" style="display:none;"></div>
            </div>
        </div>

        <div class="panel-bottom-group">
            <h4 class="panel-title">Browser</h4>
            <button id="btn-cloak-launcher" class="panel-btn">Launch New Tab</button>
            <div style="margin-bottom: 15px;"></div> 

            <h4 class="panel-title">Appearance</h4>
            <div class="settings-panel">
                <ul class="settings-list">
                    <li class="setting-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size:0.9em; color:#aaa;">Custom BG</span>
                            <div style="display: flex; gap: 5px;">
                                <button id="btn-bg-upload" class="panel-btn" style="font-size: 0.8em; margin: 0; width: auto; padding: 4px 8px;">Upload</button>
                                <button id="btn-bg-reset" class="panel-btn" style="font-size: 0.8em; margin: 0; width: auto; padding: 4px 8px; background-color: var(--color-vc-red);">Reset</button>
                            </div>
                        </div>
                        <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();

    // --- WHITEBOARD LOGIC ---
    const canvas = document.getElementById('whiteboard');
    const ctx = canvas.getContext('2d');
    const wbWrapper = document.getElementById('canvas-container');
    let drawing = false, lastX=0, lastY=0;

    function resizeCanvas() {
        canvas.width = wbWrapper.offsetWidth;
        canvas.height = wbWrapper.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    setTimeout(resizeCanvas, 500);

    function draw(x0, y0, x1, y1, color, size, emit) {
        ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x1, y1);
        ctx.strokeStyle = color; ctx.lineWidth = size; ctx.lineCap = 'round'; ctx.stroke(); ctx.closePath();
        if(emit) {
            const w = canvas.width, h = canvas.height;
            socket.emit('wb-draw', { x0: x0/w, y0: y0/h, x1: x1/w, y1: y1/h, color, size });
        }
    }

    canvas.addEventListener('mousedown', (e) => { drawing=true; lastX=e.offsetX; lastY=e.offsetY; });
    canvas.addEventListener('mouseup', () => drawing=false);
    canvas.addEventListener('mousemove', (e) => {
        if(!drawing) return;
        draw(lastX, lastY, e.offsetX, e.offsetY, document.getElementById('wb-color').value, document.getElementById('wb-size').value, true);
        lastX=e.offsetX; lastY=e.offsetY;
    });

    // Touch Support
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); const r = canvas.getBoundingClientRect(); drawing=true; lastX=e.touches[0].clientX-r.left; lastY=e.touches[0].clientY-r.top; }, {passive:false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if(!drawing)return; const r = canvas.getBoundingClientRect(); const x=e.touches[0].clientX-r.left; const y=e.touches[0].clientY-r.top; draw(lastX, lastY, x, y, document.getElementById('wb-color').value, document.getElementById('wb-size').value, true); lastX=x; lastY=y; }, {passive:false});
    canvas.addEventListener('touchend', () => drawing=false);

    socket.on('wb-draw', (d) => draw(d.x0*canvas.width, d.y0*canvas.height, d.x1*canvas.width, d.y1*canvas.height, d.color, d.size, false));
    socket.on('wb-history', (lines) => lines.forEach(l => draw(l.x0*canvas.width, l.y0*canvas.height, l.x1*canvas.width, l.y1*canvas.height, l.color, l.size, false)));
    socket.on('wb-redraw-all', () => ctx.clearRect(0,0,canvas.width,canvas.height));
    document.getElementById('wb-clear-btn').addEventListener('click', () => socket.emit('wb-clear'));


    // --- YOUR ORIGINAL CHAT LOGIC ---
    const messagesDiv = document.getElementById('messages');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const onlineUsersList = document.getElementById('online-users-list');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const typingIndicator = document.getElementById('typing-indicator');

    // Appearance Inputs
    const btnBgUpload = document.getElementById('btn-bg-upload');
    const btnBgReset = document.getElementById('btn-bg-reset');
    const bgUploadInput = document.getElementById('bg-upload-input');
    const btnCloakLauncher = document.getElementById('btn-cloak-launcher');

    let currentUsername = '';
    let currentAvatarBase64 = ''; 
    let stagedImage = null; 
    let typingTimeout = null;

    // Load Data
    const storedUsername = localStorage.getItem('chatUsername');
    const storedAvatar = localStorage.getItem('chatAvatar');
    const savedBg = localStorage.getItem('custom-bg');

    if (savedBg) {
        document.body.style.backgroundImage = `url(${savedBg})`;
        document.body.classList.add('transparent-mode');
    }
    if (storedAvatar) {
        currentAvatarBase64 = storedAvatar;
        currentAvatarPreview.src = storedAvatar;
    }
    if (storedUsername) {
        usernameInput.value = storedUsername;
        socket.emit('set-username', { username: storedUsername, avatar: currentAvatarBase64 });
        currentUsername = storedUsername;
        usernameInput.disabled = true; setUsernameBtn.disabled = true;
    }

    setUsernameBtn.addEventListener('click', () => {
        const name = usernameInput.value.trim();
        if (name) {
            currentUsername = name;
            localStorage.setItem('chatUsername', name);
            socket.emit('set-username', { username: name, avatar: currentAvatarBase64 });
            usernameInput.disabled = true; setUsernameBtn.disabled = true;
        }
    });

    function sendMessage() {
        const text = messageInput.value.trim();
        if ((!text && !stagedImage) || !currentUsername) return;
        socket.emit('chat-message', { text, image: stagedImage });
        messageInput.value = '';
        stagedImage = null; imagePreviewArea.style.display = 'none'; hiddenFileInput.value = '';
        socket.emit('typing-stop');
    }
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});

    socket.on('chat-message', (msg) => {
        const div = document.createElement('div');
        div.className = 'message ' + (msg.sender === currentUsername ? 'user-message' : 'other-message');
        const imgHtml = msg.image ? `<img src="${msg.image}" class="message-image">` : '';
        div.innerHTML = `<div class="bubble-content"><b>${msg.sender}</b>: ${msg.text}${imgHtml}</div>`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('history', (msgs) => {
        messagesDiv.innerHTML = '';
        msgs.forEach(msg => {
            const div = document.createElement('div');
            div.className = 'message ' + (msg.sender === currentUsername ? 'user-message' : 'other-message');
            const imgHtml = msg.image ? `<img src="${msg.image}" class="message-image">` : '';
            div.innerHTML = `<div class="bubble-content"><b>${msg.sender}</b>: ${msg.text}${imgHtml}</div>`;
            messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    socket.on('user-list-update', (users) => {
        onlineUsersList.innerHTML = users.map(u => `<li>${u.username}</li>`).join('');
    });

    // Uploads
    fileUploadBtn.addEventListener('click', () => hiddenFileInput.click());
    hiddenFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => { stagedImage = evt.target.result; imagePreview.src = stagedImage; imagePreviewArea.style.display = 'flex'; };
            reader.readAsDataURL(file);
        }
    });
    removeImageBtn.addEventListener('click', () => { stagedImage = null; imagePreviewArea.style.display = 'none'; hiddenFileInput.value=''; });

    // Backgrounds
    btnBgUpload.addEventListener('click', () => bgUploadInput.click());
    bgUploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                localStorage.setItem('custom-bg', evt.target.result);
                document.body.style.backgroundImage = `url(${evt.target.result})`;
                document.body.classList.add('transparent-mode');
            };
            reader.readAsDataURL(file);
        }
    });
    btnBgReset.addEventListener('click', () => {
        localStorage.removeItem('custom-bg');
        document.body.style.backgroundImage = '';
        document.body.classList.remove('transparent-mode');
    });

    // Cloak Launcher (Your Original Logic)
    if(btnCloakLauncher) {
        btnCloakLauncher.addEventListener('click', () => {
            const win = window.open('about:blank', '_blank');
            if(win) {
                win.document.write('<iframe src="https://tuff.speedslicer.dev/files/1_1UT8/WASM/" style="border:0; width:100vw; height:100vh;"></iframe>');
                win.document.close();
            }
        });
    }

    // VC Logic Placeholder
    document.getElementById('vc-btn-join').addEventListener('click', () => socket.emit('vc-join'));
    socket.on('vc-user-list-update', (list) => {
        document.getElementById('vc-user-list').innerHTML = list.map(u => `<li>${u.username}</li>`).join('');
    });
</script>
</body>
</html>
