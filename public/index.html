<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="dm-sidebar">
        <div id="dm-header">Contacts</div>
        <div id="dm-list"></div>
    </div>

    <div id="chat-container">
        <div id="username-area">
            <div style="display:flex; align-items:center; gap:10px;">
                <button id="avatar-upload-btn" title="Set Avatar">
                    <img id="current-avatar-preview" src="placeholder-avatar.png" alt="Avatar">
                </button>
                <h3 id="chat-header-label">username:</h3>
            </div>
            
            <div id="username-controls">
                <input type="text" id="username-input" placeholder="Enter name...">
                <button id="set-username-btn">Save</button>
            </div>
        </div>
        
        <div id="messages"></div>
        
        <button id="scroll-down-btn">‚Üì New Messages</button>
        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="reply-bar" style="display:none;">
                <span>Replying to <b id="reply-target-name">User</b></span>
                <button id="cancel-reply-btn">X</button>
            </div>

            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>

            <div id="input-row">
                <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
                <button id="file-upload-btn" title="Upload Image">üìÅ</button>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>
    
    <div id="right-panel">
        <div class="panel-top-group">
            <div>
                <h4 class="panel-title">Voice Chat</h4>
                <button id="vc-btn-join" class="panel-btn">Join Call</button>
                <div style="display: flex; gap: 5px;">
                    <button id="vc-btn-mute" class="panel-btn" style="display: none; flex: 1;">Mute</button>
                    <button id="vc-btn-leave" class="panel-btn" style="display: none; flex: 1; background-color: var(--color-vc-red); border-color: #a00;">Leave</button>
                </div>
                <ul id="vc-user-list"></ul>
                <div id="audio-container"></div>
            </div>
        </div>
        <div class="panel-bottom-group">
            <h4 class="panel-title">Settings</h4>
            <div class="settings-panel">
                <ul class="settings-list">
                    <li class="setting-item">
                        <span>Background</span>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-bg-upload" class="panel-btn" style="font-size: 0.8em; margin: 0; width: auto; padding: 4px;">Upload</button>
                            <button id="btn-bg-reset" class="panel-btn" style="font-size: 0.8em; margin: 0; width: auto; padding: 4px; background: #555;">Reset</button>
                        </div>
                        <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();

    // --- DOM Elements ---
    const messagesDiv = document.getElementById('messages');
    const scrollDownBtn = document.getElementById('scroll-down-btn');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');
    const dmList = document.getElementById('dm-list');
    const chatHeaderLabel = document.querySelector('#username-area h3');
    const typingIndicator = document.getElementById('typing-indicator');

    // Reply & File Elements
    const replyBar = document.getElementById('reply-bar');
    const replyTargetName = document.getElementById('reply-target-name');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');

    // VC Elements
    const vcBtnJoin = document.getElementById('vc-btn-join');
    const vcBtnMute = document.getElementById('vc-btn-mute');
    const vcBtnLeave = document.getElementById('vc-btn-leave');
    const vcUserList = document.getElementById('vc-user-list');
    const audioContainer = document.getElementById('audio-container');

    // State Variables
    let currentUsername = '';
    let currentAvatarBase64 = ''; 
    let stagedImage = null; 
    let currentChatMode = 'global'; 
    let currentDmTarget = null;
    let allUsersCache = []; 
    let unreadCounts = {}; 
    let currentReplyTo = null;
    let typingTimeout = null;
    
    // VC State
    let localStream = null;
    let peers = {}; 
    let isInVC = false;
    let isMuted = false;
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // --- Sidebar Logic (Restored) ---
    function renderSidebar() {
        dmList.innerHTML = '';

        // 1. Global Chat Card
        const mainChatCard = document.createElement('div');
        mainChatCard.className = 'dm-user-card';
        if (currentChatMode === 'global') mainChatCard.classList.add('active');
        
        const mainWrapper = document.createElement('div');
        mainWrapper.className = 'dm-avatar-wrapper';
        const mainImg = document.createElement('img');
        mainImg.src = 'placeholder-avatar.png'; 
        mainWrapper.appendChild(mainImg);
        
        const mainName = document.createElement('div');
        mainName.className = 'dm-username';
        mainName.innerText = "Global Chat";
        
        mainChatCard.appendChild(mainWrapper);
        mainChatCard.appendChild(mainName);
        mainChatCard.onclick = () => switchToGlobal();
        dmList.appendChild(mainChatCard);

        // 2. User List
        const sortedUsers = [...allUsersCache].sort((a, b) => {
            if (a.online === b.online) return a.username.localeCompare(b.username);
            return a.online ? -1 : 1;
        });

        sortedUsers.forEach(u => {
            if (u.username === currentUsername) return; 
            
            const card = document.createElement('div');
            card.className = 'dm-user-card';
            if (currentChatMode === 'dm' && currentDmTarget === u.username) card.classList.add('active');
            
            const wrapper = document.createElement('div');
            wrapper.className = 'dm-avatar-wrapper';
            const img = document.createElement('img');
            img.src = u.avatar || 'placeholder-avatar.png';
            
            const statusBubble = document.createElement('div');
            statusBubble.className = `status-bubble ${u.online ? 'status-online' : 'status-offline'}`;
            
            const unreadBadge = document.createElement('div');
            unreadBadge.className = 'unread-badge';
            if (unreadCounts[u.username] > 0) {
                unreadBadge.innerText = unreadCounts[u.username];
                unreadBadge.classList.add('visible');
            }
            
            wrapper.appendChild(img);
            wrapper.appendChild(statusBubble);
            wrapper.appendChild(unreadBadge);
            
            const name = document.createElement('div');
            name.className = 'dm-username';
            name.innerText = u.username;
            
            card.appendChild(wrapper);
            card.appendChild(name);
            card.onclick = () => switchToDm(u.username);
            dmList.appendChild(card);
        });
    }

    function switchToDm(targetUser) {
        currentChatMode = 'dm';
        currentDmTarget = targetUser;
        unreadCounts[targetUser] = 0;
        renderSidebar();
        chatHeaderLabel.innerText = `Chat with ${targetUser}`;
        messagesDiv.innerHTML = '';
        socket.emit('fetch-dm-history', targetUser);
    }

    function switchToGlobal() {
        currentChatMode = 'global';
        currentDmTarget = null;
        renderSidebar();
        chatHeaderLabel.innerText = 'username:';
        messagesDiv.innerHTML = '';
        socket.emit('get-history');
    }

    // --- Core Chat Logic ---
    function sendMessage() {
        const text = messageInput.value.trim();
        if ((!text && !stagedImage) || !currentUsername) return; 
        
        const payload = {
            text: text,
            image: stagedImage,
            replyTo: currentReplyTo
        };

        if (currentChatMode === 'global') socket.emit('chat-message', payload);
        else socket.emit('send-dm', { target: currentDmTarget, ...payload });
        
        messageInput.value = ''; 
        stagedImage = null; 
        imagePreviewArea.style.display = 'none'; 
        hiddenFileInput.value = '';
        currentReplyTo = null;
        replyBar.style.display = 'none';
    }

    // --- Message Rendering ---
    function createMessageElement(msg) {
        if (msg.type === 'system') {
            const sysDiv = document.createElement('div');
            sysDiv.className = 'system-message';
            sysDiv.innerText = msg.text;
            return sysDiv;
        }

        const messageEl = document.createElement('div');
        messageEl.className = 'message';
        const isMe = (msg.sender === currentUsername);
        isMe ? messageEl.classList.add('user-message') : messageEl.classList.add('other-message');
        
        // Actions (Reply/Edit/Delete)
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        
        const replyBtn = document.createElement('button');
        replyBtn.innerHTML = '‚Ü©';
        replyBtn.onclick = () => {
            currentReplyTo = { id: msg.id, sender: msg.sender, text: msg.text };
            replyTargetName.innerText = msg.sender;
            replyBar.style.display = 'flex';
            messageInput.focus();
        };
        actionsDiv.appendChild(replyBtn);

        if (isMe) {
            const delBtn = document.createElement('button');
            delBtn.innerHTML = 'üóë';
            delBtn.onclick = () => { if(confirm("Delete?")) socket.emit('delete-message', msg.id); };
            actionsDiv.appendChild(delBtn);
        }

        const contentWrapper = document.createElement('div');
        contentWrapper.classList.add('message-content-wrapper');

        // Reply Context
        if (msg.replyTo) {
            const replyBlock = document.createElement('div');
            replyBlock.className = 'reply-context';
            replyBlock.innerHTML = `<strong>${msg.replyTo.sender}:</strong> ${msg.replyTo.text.substring(0,30)}...`;
            contentWrapper.appendChild(replyBlock);
        }

        const bubbleContent = document.createElement('div');
        bubbleContent.classList.add('bubble-content');
        
        if (msg.image) {
            const img = document.createElement('img');
            img.src = msg.image; 
            img.classList.add('message-image');
            bubbleContent.appendChild(img);
        }
        
        if (msg.text) {
            const textSpan = document.createElement('span');
            textSpan.className = 'message-text';
            textSpan.innerText = msg.text;
            bubbleContent.appendChild(textSpan);
        }
        
        const timeDiv = document.createElement('div');
        timeDiv.classList.add('message-time');
        timeDiv.textContent = msg.time;
        
        contentWrapper.appendChild(bubbleContent);
        contentWrapper.appendChild(timeDiv);
        
        // Assemble
        if (msg.avatar) {
            const avatarImg = document.createElement('img');
            avatarImg.src = msg.avatar; 
            avatarImg.classList.add('avatar');
            messageEl.appendChild(avatarImg);
        }
        
        messageEl.appendChild(contentWrapper);
        messageEl.appendChild(actionsDiv); 
        return messageEl;
    }

    function appendMessageToUI(msg) {
        const el = createMessageElement(msg);
        messagesDiv.appendChild(el);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // --- Socket Listeners ---
    socket.on('chat-message', (msg) => { 
        if (currentChatMode === 'global') appendMessageToUI(msg); 
    });
    
    socket.on('dm-received', (data) => {
        if (currentChatMode === 'dm' && (data.from === currentDmTarget || data.to === currentDmTarget)) {
            appendMessageToUI(data.message);
        } else if (data.from !== currentUsername) {
            if (!unreadCounts[data.from]) unreadCounts[data.from] = 0;
            unreadCounts[data.from]++;
            renderSidebar();
        }
    });

    socket.on('history', (h) => { h.forEach(appendMessageToUI); });
    socket.on('dm-history', (data) => { data.messages.forEach(appendMessageToUI); });
    
    socket.on('sidebar-user-list', (list) => { allUsersCache = list; renderSidebar(); });
    socket.on('message-deleted', (id) => { 
        // Simple reload for now or remove element
        const el = document.querySelectorAll('.message'); // simplified finding
        messagesDiv.innerHTML = ''; // lazy refresh
        if(currentChatMode === 'global') socket.emit('get-history');
        else socket.emit('fetch-dm-history', currentDmTarget);
    });

    // --- Setup & Handlers ---
    cancelReplyBtn.onclick = () => { currentReplyTo = null; replyBar.style.display = 'none'; };
    sendButton.onclick = sendMessage;
    messageInput.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

    // File Handling
    fileUploadBtn.onclick = () => hiddenFileInput.click();
    hiddenFileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            stagedImage = evt.target.result;
            imagePreview.src = stagedImage;
            imagePreviewArea.style.display = 'flex';
        };
        reader.readAsDataURL(file);
    };
    removeImageBtn.onclick = () => { stagedImage = null; imagePreviewArea.style.display = 'none'; hiddenFileInput.value = ''; };

    // Avatar
    avatarUploadBtn.onclick = () => {
        const i = document.createElement('input'); i.type = 'file'; i.accept = 'image/*';
        i.onchange = (e) => {
            const f = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                currentAvatarBase64 = evt.target.result;
                currentAvatarPreview.src = currentAvatarBase64;
                if(currentUsername) socket.emit('set-username', {username: currentUsername, avatar: currentAvatarBase64});
                localStorage.setItem('chatAvatar', currentAvatarBase64);
            };
            reader.readAsDataURL(f);
        };
        i.click();
    };

    // Initialization
    const savedUser = localStorage.getItem('chatUsername');
    const savedAvatar = localStorage.getItem('chatAvatar');
    if (savedAvatar) { currentAvatarBase64 = savedAvatar; currentAvatarPreview.src = savedAvatar; }
    if (savedUser) { 
        usernameInput.value = savedUser; 
        currentUsername = savedUser; 
        usernameInput.disabled = true; 
        setUsernameBtn.disabled = true; 
        socket.emit('set-username', {username: savedUser, avatar: currentAvatarBase64 || 'placeholder-avatar.png'});
    }
    setUsernameBtn.onclick = () => {
        const u = usernameInput.value.trim();
        if(u) {
            localStorage.setItem('chatUsername', u);
            currentUsername = u;
            socket.emit('set-username', {username: u, avatar: currentAvatarBase64 || 'placeholder-avatar.png'});
            usernameInput.disabled = true; 
            setUsernameBtn.disabled = true;
        }
    };

    // --- VC Logic (Simplified) ---
    vcBtnJoin.onclick = async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        socket.emit('vc-join'); isInVC = true;
        vcBtnJoin.style.display = 'none'; vcBtnLeave.style.display = 'inline-block'; vcBtnMute.style.display = 'inline-block';
    };
    vcBtnLeave.onclick = () => {
        socket.emit('vc-leave'); isInVC = false;
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        audioContainer.innerHTML = '';
        vcBtnJoin.style.display = 'inline-block'; vcBtnLeave.style.display = 'none'; vcBtnMute.style.display = 'none';
    };
    // (Other VC handlers would go here, simplified for space in rollback)
    socket.on('vc-user-list-update', (users) => {
        vcUserList.innerHTML = '';
        users.forEach(u => { const li = document.createElement('li'); li.innerText = u.username; vcUserList.appendChild(li); });
    });
</script>
</body>
</html>
