<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="whiteboard-area">
        <div class="wb-header">
            <span>Whiteboard</span>
            <div class="wb-controls">
                <input type="color" id="wb-color" value="#ffffff">
                <button id="wb-clear-btn" title="Clear Board">üóëÔ∏è</button>
            </div>
        </div>
        <canvas id="wb-canvas"></canvas>
    </div>

    <div id="chat-container">
        <div id="username-area">
            <button id="avatar-upload-btn" title="Set Avatar">
                <img id="current-avatar-preview" src="placeholder-avatar.png" alt="Avatar">
            </button>
            <h3>username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list"></ul>
        </div>
        
        <div id="messages"></div>
        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>
            
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <input type="file" id="hidden-file-input" accept="image/*" style="display:none;">
            <button id="upload-btn" title="Upload Image">üì∑</button>
            <button id="send-btn">Send</button>
        </div>
    </div>

    <div id="right-panel">
        <button id="toggle-panel-btn">‚ò∞</button>

        <div id="panel-content">
            <h3>Settings</h3>
            <div class="panel-section">
                <label>Background Image URL:</label>
                <input type="text" id="bg-url-input" placeholder="https://...">
                <button id="set-bg-btn">Set BG</button>
                <button id="clear-bg-btn">Reset</button>
            </div>
            <div class="panel-section">
                <label>Transparent Mode:</label>
                <input type="checkbox" id="transparent-mode-toggle">
            </div>
            <div class="panel-section">
                <label>Cloak Launcher:</label>
                <button id="btn-cloak-launcher">Launch New Tab</button>
            </div>

            <hr>
            <h3>Voice Chat</h3>
            <div id="vc-controls">
                <button id="join-vc-btn">Join VC</button>
                <button id="leave-vc-btn" disabled>Leave VC</button>
                <button id="mute-vc-btn" disabled>Mute</button>
            </div>
            <div id="vc-participants"></div>
        </div>
    </div>

</div>

<script>
    const socket = io();

    // --- Chat Elements ---
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const onlineList = document.getElementById('online-users-list');
    const fileInput = document.getElementById('hidden-file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const imgPreviewArea = document.getElementById('image-preview-area');
    const imgPreview = document.getElementById('image-preview');
    const removeImgBtn = document.getElementById('remove-image-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');

    // --- Right Panel Elements ---
    const rightPanel = document.getElementById('right-panel');
    const togglePanelBtn = document.getElementById('toggle-panel-btn');
    const bgUrlInput = document.getElementById('bg-url-input');
    const setBgBtn = document.getElementById('set-bg-btn');
    const clearBgBtn = document.getElementById('clear-bg-btn');
    const transparentToggle = document.getElementById('transparent-mode-toggle');
    const btnCloakLauncher = document.getElementById('btn-cloak-launcher');

    // --- VC Elements ---
    const joinVcBtn = document.getElementById('join-vc-btn');
    const leaveVcBtn = document.getElementById('leave-vc-btn');
    const muteVcBtn = document.getElementById('mute-vc-btn');
    const vcParticipantsDiv = document.getElementById('vc-participants');

    let currentImage = null;
    let myUsername = localStorage.getItem('chat_username') || '';
    let myAvatar = localStorage.getItem('chat_avatar') || 'placeholder-avatar.png';
    let typingTimeout;
    let localStream;
    let isMuted = false;

    if (myUsername) usernameInput.value = myUsername;
    currentAvatarPreview.src = myAvatar;

    // Load Settings
    const savedBg = localStorage.getItem('chat_bg');
    if (savedBg) document.body.style.backgroundImage = `url('${savedBg}')`;
    const savedTransparent = localStorage.getItem('chat_transparent');
    if (savedTransparent === 'true') {
        document.body.classList.add('transparent-mode');
        transparentToggle.checked = true;
    }

    // --- Helper ---
    function scrollToBottom() { messagesDiv.scrollTop = messagesDiv.scrollHeight; }

    // --- Event Listeners ---
    setUsernameBtn.addEventListener('click', () => {
        myUsername = usernameInput.value;
        if (myUsername) {
            localStorage.setItem('chat_username', myUsername);
            socket.emit('set-username', { username: myUsername, avatar: myAvatar });
            alert('Username set!');
        }
    });

    const sendMessage = () => {
        const text = msgInput.value;
        if (text.trim() || currentImage) {
            socket.emit('chat-message', { text, image: currentImage });
            msgInput.value = '';
            currentImage = null;
            imgPreviewArea.style.display = 'none';
            socket.emit('typing-stop');
        }
    };

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                currentImage = evt.target.result;
                imgPreview.src = currentImage;
                imgPreviewArea.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    });
    removeImgBtn.addEventListener('click', () => {
        currentImage = null;
        imgPreviewArea.style.display = 'none';
        fileInput.value = '';
    });

    // Simple Avatar Input
    const avatarInput = document.createElement('input');
    avatarInput.type = 'file'; avatarInput.accept = 'image/*'; avatarInput.style.display = 'none';
    document.body.appendChild(avatarInput);
    avatarUploadBtn.addEventListener('click', () => avatarInput.click());
    avatarInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                myAvatar = evt.target.result;
                currentAvatarPreview.src = myAvatar;
                localStorage.setItem('chat_avatar', myAvatar);
                if(myUsername) socket.emit('set-username', { username: myUsername, avatar: myAvatar });
            };
            reader.readAsDataURL(file);
        }
    });

    msgInput.addEventListener('input', () => {
        socket.emit('typing-start');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => socket.emit('typing-stop'), 1000);
    });

    togglePanelBtn.addEventListener('click', () => {
        rightPanel.classList.toggle('collapsed');
        togglePanelBtn.innerHTML = rightPanel.classList.contains('collapsed') ? '‚öôÔ∏è' : '‚ò∞';
    });

    setBgBtn.addEventListener('click', () => {
        const url = bgUrlInput.value;
        if(url) { document.body.style.backgroundImage = `url('${url}')`; localStorage.setItem('chat_bg', url); }
    });
    clearBgBtn.addEventListener('click', () => {
        document.body.style.backgroundImage = ''; localStorage.removeItem('chat_bg');
    });
    transparentToggle.addEventListener('change', (e) => {
        if(e.target.checked) {
            document.body.classList.add('transparent-mode');
            localStorage.setItem('chat_transparent', 'true');
        } else {
            document.body.classList.remove('transparent-mode');
            localStorage.setItem('chat_transparent', 'false');
        }
    });

    // --- Socket Events ---
    socket.on('connect', () => {
        if (myUsername) socket.emit('set-username', { username: myUsername, avatar: myAvatar });
    });

    socket.on('update-user-list', (users) => {
        onlineList.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.innerHTML = `<img src="${u.avatar}" class="small-avatar"> ${u.username} ${u.isAdmin ? 'üëë' : ''}`;
            onlineList.appendChild(li);
        });
    });

    socket.on('chat-message', (msg) => {
        const div = document.createElement('div');
        div.classList.add('message');
        if (msg.username === myUsername) div.classList.add('my-message');
        
        const avatarImg = `<img src="${msg.avatar}" class="msg-avatar">`;
        let content = `<div class="bubble-content">`;
        if (msg.username !== myUsername) content += `<div class="sender-name">${msg.username}</div>`;
        
        if (msg.type === 'image') {
            content += `<img src="${msg.image}" class="chat-image"><br>${msg.text}`;
        } else {
            const linkified = msg.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            content += linkified;
        }
        content += `<span class="time">${msg.time}</span></div>`;

        div.innerHTML = (msg.username === myUsername) ? `${content} ${avatarImg}` : `${avatarImg} ${content}`;
        messagesDiv.appendChild(div);
        scrollToBottom();
    });

    socket.on('history', (history) => {
        messagesDiv.innerHTML = '';
        history.forEach(msg => {
            const div = document.createElement('div');
            div.classList.add('message');
            if (msg.username === myUsername) div.classList.add('my-message');
            const avatarImg = `<img src="${msg.avatar}" class="msg-avatar">`;
            let content = `<div class="bubble-content">`;
            if (msg.username !== myUsername) content += `<div class="sender-name">${msg.username}</div>`;
            if (msg.type === 'image') content += `<img src="${msg.image}" class="chat-image"><br>${msg.text}`;
            else content += msg.text;
            content += `</div>`;
            div.innerHTML = (msg.username === myUsername) ? `${content} ${avatarImg}` : `${avatarImg} ${content}`;
            messagesDiv.appendChild(div);
        });
        scrollToBottom();
    });

    socket.on('user-typing', (u) => typingIndicator.innerText = `${u} is typing...`);
    socket.on('user-stopped-typing', () => typingIndicator.innerText = '');
    socket.on('clear-chat', () => messagesDiv.innerHTML = '');

    // --- Voice Chat ---
    joinVcBtn.addEventListener('click', () => {
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            .then(stream => {
                localStream = stream;
                joinVcBtn.disabled = true; leaveVcBtn.disabled = false; muteVcBtn.disabled = false;
                socket.emit('vc-join');
            })
            .catch(err => alert('Could not access microphone'));
    });

    leaveVcBtn.addEventListener('click', () => {
        if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
        socket.emit('vc-leave');
        joinVcBtn.disabled = false; leaveVcBtn.disabled = true; muteVcBtn.disabled = true;
    });

    muteVcBtn.addEventListener('click', () => {
        if (localStream) {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            muteVcBtn.innerText = isMuted ? 'Unmute' : 'Mute';
            muteVcBtn.style.backgroundColor = isMuted ? 'var(--color-vc-red)' : '';
            socket.emit('vc-mute-toggle', isMuted);
        }
    });

    socket.on('vc-update-users', (users) => {
        vcParticipantsDiv.innerHTML = '';
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'vc-user';
            div.innerHTML = `<img src="${u.avatar}"> <span>${u.username}</span> ${u.isMuted ? 'üîá' : 'üé§'}`;
            vcParticipantsDiv.appendChild(div);
        });
    });

    // --- Whiteboard (Left) ---
    const canvas = document.getElementById('wb-canvas');
    const ctx = canvas.getContext('2d');
    const wbColor = document.getElementById('wb-color');
    const wbArea = document.getElementById('whiteboard-area');
    let drawing = false;

    function resizeCanvas() {
        const rect = wbArea.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height - 40;
    }
    window.addEventListener('resize', resizeCanvas);
    setTimeout(resizeCanvas, 500);

    function drawLine(x0, y0, x1, y1, color, emit) {
        ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x1, y1);
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke(); ctx.closePath();
        if (!emit) return;
        socket.emit('drawing', { x0: x0/canvas.width, y0: y0/canvas.height, x1: x1/canvas.width, y1: y1/canvas.height, color });
    }

    let current = {x: 0, y: 0};
    canvas.addEventListener('mousedown', (e) => { drawing = true; current.x = e.offsetX; current.y = e.offsetY; });
    canvas.addEventListener('mouseup', (e) => { if (!drawing) return; drawing = false; drawLine(current.x, current.y, e.offsetX, e.offsetY, wbColor.value, true); });
    canvas.addEventListener('mousemove', (e) => { 
        if (!drawing) return; 
        drawLine(current.x, current.y, e.offsetX, e.offsetY, wbColor.value, true); 
        current.x = e.offsetX; current.y = e.offsetY; 
    });

    document.getElementById('wb-clear-btn').addEventListener('click', () => socket.emit('clear-board'));

    socket.on('drawing', (data) => drawLine(data.x0*canvas.width, data.y0*canvas.height, data.x1*canvas.width, data.y1*canvas.height, data.color, false));
    socket.on('clear-board', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
    socket.on('whiteboard-history', (history) => {
        setTimeout(() => history.forEach(d => drawLine(d.x0*canvas.width, d.y0*canvas.height, d.x1*canvas.width, d.y1*canvas.height, d.color, false)), 500);
    });

    // --- Cloak Launcher ---
    if (btnCloakLauncher) {
        btnCloakLauncher.addEventListener('click', () => {
            const win = window.open('about:blank', '_blank');
            if(win) {
                win.document.write(`<iframe src="https://tuff.speedslicer.dev/files/1_1UT8/WASM/" style="width:100vw;height:100vh;border:none;"></iframe>`);
                win.document.close();
            } else alert("Pop-up blocked");
        });
    }
</script>
</body>
</html>
