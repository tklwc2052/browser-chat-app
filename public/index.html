<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div id="main-wrapper">
    <div id="dm-sidebar">
        <div id="dm-header">Contacts</div>
        <div id="dm-list">
            </div>
        <div style="padding: 10px; border-top: 1px solid #333;">
            <button id="return-global-btn">Global Chat</button>
        </div>
    </div>

    <div id="chat-container">
        <div id="username-area">
            <button id="avatar-upload-btn" title="Set Avatar">
                <img id="current-avatar-preview" src="placeholder-avatar.png" alt="Avatar">
            </button>
            <h3 id="chat-header-label">username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list"></ul>
        </div>
        
        <div id="messages"></div>

        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>
            
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <input type="file" id="hidden-file-input" accept="image/*" style="display:none;">
            <button id="image-upload-btn">ðŸ“·</button>
            <button id="send-btn">Send</button>
            
            <button id="vc-join-btn" class="vc-btn">Join VC</button>
            <button id="vc-leave-btn" class="vc-btn hidden">Leave VC</button>
            <button id="vc-mute-btn" class="vc-btn hidden">Mute</button>
        </div>
    </div>
</div>

<div id="vc-overlay" class="hidden">
    <div id="vc-container">
        <h3>Voice Chat</h3>
        <div id="vc-users-grid"></div>
    </div>
</div>

<button id="cloak-launcher-btn">Launch New Tab</button>

<script>
    const socket = io();
    
    // UI References
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const onlineList = document.getElementById('online-users-list');
    const typingIndicator = document.getElementById('typing-indicator');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');
    const imageUploadBtn = document.getElementById('image-upload-btn');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const btnCloakLauncher = document.getElementById('cloak-launcher-btn');

    // Sidebar & DM UI References
    const dmList = document.getElementById('dm-list');
    const returnGlobalBtn = document.getElementById('return-global-btn');
    const chatHeaderLabel = document.getElementById('chat-header-label');
    const onlineUsersArea = document.getElementById('online-users-area');

    // State Variables
    let username = '';
    let avatar = null;
    let selectedImage = null;
    let typingTimeout;

    // DM State
    let currentChatMode = 'global'; // 'global' or 'dm'
    let currentDmTarget = null;
    let allUsersCache = []; 
    let unreadCounts = {}; 

    // --- SIDEBAR LOGIC ---

    function renderSidebar() {
        dmList.innerHTML = '';
        
        // Sort: Online first, then alphabetical
        const sortedUsers = [...allUsersCache].sort((a, b) => {
            if (a.online === b.online) return a.username.localeCompare(b.username);
            return a.online ? -1 : 1;
        });

        sortedUsers.forEach(u => {
            // Don't show yourself in DM list
            if (u.username === username) return;

            const card = document.createElement('div');
            card.className = 'dm-user-card';
            if (currentChatMode === 'dm' && currentDmTarget === u.username) {
                card.classList.add('active');
            }

            // Avatar & Bubbles
            const wrapper = document.createElement('div');
            wrapper.className = 'dm-avatar-wrapper';
            
            const img = document.createElement('img');
            img.src = u.avatar || 'placeholder-avatar.png';
            
            const statusBubble = document.createElement('div');
            statusBubble.className = `status-bubble ${u.online ? 'status-online' : 'status-offline'}`;
            
            const unreadBadge = document.createElement('div');
            unreadBadge.className = 'unread-badge';
            if (unreadCounts[u.username] && unreadCounts[u.username] > 0) {
                unreadBadge.innerText = unreadCounts[u.username];
                unreadBadge.classList.add('visible');
            }

            wrapper.appendChild(img);
            wrapper.appendChild(statusBubble);
            wrapper.appendChild(unreadBadge);

            const name = document.createElement('div');
            name.className = 'dm-username';
            name.innerText = u.username;

            card.appendChild(wrapper);
            card.appendChild(name);
            
            card.onclick = () => switchToDm(u.username);
            dmList.appendChild(card);
        });
    }

    function switchToDm(targetUser) {
        currentChatMode = 'dm';
        currentDmTarget = targetUser;
        unreadCounts[targetUser] = 0; // Clear unread
        renderSidebar();
        
        messagesDiv.innerHTML = ''; // Clear chat view
        chatHeaderLabel.innerText = `Chat with ${targetUser}`;
        onlineUsersArea.style.display = 'none'; // Hide online list in DM mode
        
        socket.emit('fetch-dm-history', targetUser);
    }

    returnGlobalBtn.onclick = () => {
        // Easiest way to restore global state strictly is to reload
        // or we can manually reset state, but reload ensures sync.
        window.location.reload(); 
    };

    // --- SOCKET LISTENERS (DM) ---

    socket.on('sidebar-user-list', (list) => {
        allUsersCache = list;
        renderSidebar();
    });

    socket.on('user-status-change', (data) => {
        const user = allUsersCache.find(u => u.username === data.username);
        if (user) {
            user.online = data.online;
            if(data.avatar) user.avatar = data.avatar;
        } else {
            allUsersCache.push({ username: data.username, online: data.online, avatar: data.avatar });
        }
        renderSidebar();
    });

    socket.on('dm-history', (data) => {
        if (currentChatMode === 'dm' && currentDmTarget === data.target) {
            messagesDiv.innerHTML = '';
            data.messages.forEach(msg => addMessageToUI(msg));
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    });

    socket.on('dm-received', (data) => {
        // If we are currently looking at this DM
        if (currentChatMode === 'dm' && (data.from === currentDmTarget || data.to === currentDmTarget)) {
            addMessageToUI(data.message);
        } else {
            // It's a background DM
            if (data.from !== username) { // Don't notify self
                if (!unreadCounts[data.from]) unreadCounts[data.from] = 0;
                unreadCounts[data.from]++;
                renderSidebar();
            }
        }
    });

    // --- STANDARD CHAT LOGIC ---

    // Avatar Upload
    avatarUploadBtn.addEventListener('click', () => hiddenFileInput.click());
    hiddenFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                avatar = evt.target.result;
                currentAvatarPreview.src = avatar;
                // Transparent Mode Trigger
                if (file.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
                    document.body.style.backgroundImage = `url(${avatar})`;
                    document.body.classList.add('transparent-mode');
                }
            };
            reader.readAsDataURL(file);
        }
    });

    setUsernameBtn.addEventListener('click', () => {
        const name = usernameInput.value.trim();
        if (name) {
            username = name;
            socket.emit('join', { username: username, avatar: avatar });
            document.getElementById('username-area').style.display = 'none';
            renderSidebar(); // Update sidebar to hide self
        }
    });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        if (!username) { alert("Set username first!"); return; }
        const msg = messageInput.value.trim();
        
        if (msg || selectedImage) {
            if (currentChatMode === 'global') {
                socket.emit('chatMessage', { message: msg, image: selectedImage });
            } else {
                socket.emit('send-dm', { target: currentDmTarget, message: msg, image: selectedImage });
            }
            
            messageInput.value = '';
            selectedImage = null;
            imagePreviewArea.style.display = 'none';
        }
    }

    socket.on('chat-message', (msg) => {
        if (currentChatMode === 'global') addMessageToUI(msg);
    });

    socket.on('history', (msgs) => {
        if (currentChatMode === 'global') {
            messagesDiv.innerHTML = '';
            msgs.forEach(addMessageToUI);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    });

    socket.on('update-user-list', (users) => {
        onlineList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user.username;
            onlineList.appendChild(li);
        });
    });

    function addMessageToUI(msg) {
        const div = document.createElement('div');
        div.className = 'message-bubble';
        
        if (msg.type === 'system') {
            div.classList.add('system');
            div.innerHTML = msg.text;
        } else {
            if (msg.sender === username) div.classList.add('self');
            
            let contentHtml = '';
            if (msg.avatar) contentHtml += `<img src="${msg.avatar}" class="msg-avatar">`;
            
            contentHtml += `<div class="bubble-content">`;
            contentHtml += `<div class="msg-meta"><strong>${msg.sender}</strong> <span class="msg-time">${msg.time}</span></div>`;
            
            if (msg.image) contentHtml += `<img src="${msg.image}" class="msg-image"><br>`;
            
            let formattedText = msg.text
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                .replace(/~~(.*?)~~/g, '<s>$1</s>');
            
            contentHtml += `<div class="msg-text">${formattedText}</div></div>`;
            div.innerHTML = contentHtml;
        }
        
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Image Helper
    imageUploadBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    selectedImage = evt.target.result;
                    imagePreview.src = selectedImage;
                    imagePreviewArea.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    });

    removeImageBtn.addEventListener('click', () => {
        selectedImage = null;
        imagePreviewArea.style.display = 'none';
    });

    // Typing
    messageInput.addEventListener('input', () => {
        socket.emit('typing-start');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => socket.emit('typing-stop'), 1000);
    });
    socket.on('user-typing', (user) => {
        typingIndicator.innerText = `${user} is typing...`;
        typingIndicator.style.display = 'block';
    });
    socket.on('user-stopped-typing', () => {
        typingIndicator.style.display = 'none';
    });

    // Cloak Launcher (Preserved)
    if (btnCloakLauncher) {
        btnCloakLauncher.addEventListener('click', () => {
             const urlToEmbed = "https://tuff.speedslicer.dev/files/1_1UT8/WASM/";
             const newWindow = window.open('about:blank', '_blank');
             if (newWindow) {
                 newWindow.document.write(`<iframe src="${urlToEmbed}" style="border:none;width:100vw;height:100vh;"></iframe>`);
             }
        });
    }
</script>
</body>
</html>
