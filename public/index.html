<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>

<style>
    /* 1. Stack the Name and the Bubble vertically */
    .message-content-area {
        display: flex;
        flex-direction: column;
        max-width: 70%;
        position: relative;
    }

    /* 2. Style the Name Tag */
    .message-sender-name {
        font-size: 0.75rem; /* Slightly smaller for cleanliness */
        color: #888;
        margin-bottom: 2px;
        margin-left: 4px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    /* 3. Align your own messages to the right */
    .user-message .message-content-area {
        align-items: flex-end;
    }
    
    /* Align your own name to the right */
    .user-message .message-sender-name {
        margin-right: 4px;
        margin-left: 0;
        color: #00ACE6; /* Make your own name blue so it stands out */
    }
</style>
</head>
<body>
<div id="main-wrapper">

    <div id="dm-sidebar">
        <div class="sidebar-header">
            <h3>Active Users</h3>
        </div>
        <div id="active-user-list">
            </div>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <div id="server-status">
                <span class="status-dot"></span>
                <span id="server-motd">Loading MOTD...</span>
            </div>
            <div id="header-actions">
               </div>
        </div>

        <div id="chat-box"></div>
        
        <div id="image-preview-area">
            <div class="preview-container">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="cancel-image-btn">Ã—</button>
            </div>
            <span style="color: #bbb; font-size: 0.9em; margin-left: 10px;">Image attached</span>
        </div>

        <div id="message-input-area">
            <button id="upload-btn" title="Upload Image">+</button>
            <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
            
            <input type="text" id="message-input" placeholder="Type a message... (/msg <user> <text>)" autocomplete="off">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <div id="right-panel">
        
        <div class="right-panel-section">
            <div class="section-header">
                <h3>Voice Chat</h3>
            </div>
            <div id="vc-controls">
                <button id="join-vc-btn" class="vc-btn">Join Voice</button>
                <button id="leave-vc-btn" class="vc-btn hidden" style="background-color: #dc3545;">Leave</button>
                <button id="mute-vc-btn" class="vc-btn hidden" style="background-color: #ffc107; color: #000;">Mute</button>
            </div>
            <div id="vc-user-list">
                <div class="vc-placeholder">No one in voice.</div>
            </div>
        </div>

        <div class="right-panel-section" style="flex: 1;">
            <div class="section-header">
                <h3>Tools & Settings</h3>
            </div>
            
            <div class="settings-list">
                <div class="setting-item-block">
                    <label>Username</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="username-input" placeholder="Enter Name">
                        <button id="set-username-btn">Set</button>
                    </div>
                </div>

                <div class="setting-item-block">
                    <label>Appearance</label>
                    <div class="toggle-row">
                        <span>Transparent Mode</span>
                        <label class="switch">
                            <input type="checkbox" id="transparent-mode-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                 
                <div class="setting-item-block">
                    <label>Cloak Launcher</label>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                         <button onclick="openCloak('https://google.com')" class="cloak-btn">Google</button>
                         <button onclick="openCloak('https://bing.com')" class="cloak-btn">Bing</button>
                         <button onclick="openCloak('https://classroom.google.com')" class="cloak-btn">Classroom</button>
                         <button onclick="openCloak('/snowrider')" class="cloak-btn" style="background: #00ACE6; color: white;">Snow Rider</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<div id="context-menu" class="context-menu">
    <div class="context-item" id="ctx-reply">Reply</div>
    <div class="context-item" id="ctx-edit">Edit</div>
    <div class="context-item" id="ctx-delete">Delete</div>
    <div class="context-item" id="ctx-dm">DM User</div>
</div>

<div id="dev-modal" style="display:none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center;">
    <div style="background-color: #1e1e1e; padding: 30px; border-radius: 8px; border: 1px solid #00ACE6; max-width: 500px; text-align: center; color: white; font-family: sans-serif; box-shadow: 0 0 20px rgba(0, 172, 230, 0.4);">
        <h2 style="margin-top: 0; color: #00ACE6;">SYSTEM UPDATE</h2>
        <p id="update-msg" style="font-size: 1.1em; line-height: 1.5; margin: 20px 0;">
            A new update has been deployed.
        </p>
        <button id="dev-ack-btn" style="padding: 10px 20px; background-color: #00ACE6; border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.2s;">
            ACKNOWLEDGE & ENTER
        </button>
    </div>
</div>

<script>
    (function() {
        const modal = document.getElementById('dev-modal');
        const btn = document.getElementById('dev-ack-btn');
        const msgPara = document.getElementById('update-msg');
        let currentServerId = null;

        if (typeof socket !== 'undefined') {
            socket.on('system-version-check', (data) => {
                const serverId = data.id || data;
                const description = data.description || "A new update has been deployed.";
                currentServerId = serverId;
                if(msgPara) msgPara.innerText = description;
                checkVersion(serverId);
            });
        }

        function checkVersion(serverId) {
            const lastSeenVersion = localStorage.getItem('agreed_build_version');
            if (lastSeenVersion != serverId) {
                modal.style.display = 'flex';
            }
        }

        btn.onclick = function() {
            modal.style.display = 'none';
            if (currentServerId) {
                localStorage.setItem('agreed_build_version', currentServerId);
            }
        };
        
        btn.onmouseover = () => btn.style.backgroundColor = '#008bb5';
        btn.onmouseout = () => btn.style.backgroundColor = '#00ACE6';
    })();
</script>

<script>
    const socket = io();

    // DOM Elements
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const activeUserList = document.getElementById('active-user-list');
    const serverMotd = document.getElementById('server-motd');
    
    // Image Upload Elements
    const uploadBtn = document.getElementById('upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const cancelImageBtn = document.getElementById('cancel-image-btn');

    // Context Menu
    const contextMenu = document.getElementById('context-menu');
    const ctxReply = document.getElementById('ctx-reply');
    const ctxEdit = document.getElementById('ctx-edit');
    const ctxDelete = document.getElementById('ctx-delete');
    const ctxDm = document.getElementById('ctx-dm');

    // Voice Chat Elements
    const joinVcBtn = document.getElementById('join-vc-btn');
    const leaveVcBtn = document.getElementById('leave-vc-btn');
    const muteVcBtn = document.getElementById('mute-vc-btn');
    const vcUserList = document.getElementById('vc-user-list');

    // Settings
    const transparentModeToggle = document.getElementById('transparent-mode-toggle');

    let myUsername = localStorage.getItem('chat_username') || '';
    let myAvatar = localStorage.getItem('chat_avatar'); 
    
    // Generate a random avatar if none exists
    if (!myAvatar) {
        const randomId = Math.floor(Math.random() * 1000);
        myAvatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${randomId}`;
        localStorage.setItem('chat_avatar', myAvatar);
    }

    let stagedImage = null; // Base64 string of image to send
    let replyTargetId = null; // ID of message being replied to
    let editingMessageId = null; // ID of message being edited
    let contextSelectedMessageId = null; // ID for context menu actions
    let contextSelectedUser = null; 

    // Voice Chat State
    let localStream = null;
    let peerConnections = {}; 
    let isVcMuted = false;
    
    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' }
        ]
    };

    // --- INITIALIZATION ---
    if (myUsername) {
        usernameInput.value = myUsername;
        socket.emit('set-username', { username: myUsername, avatar: myAvatar });
    }

    // Transparent Mode Load
    if (localStorage.getItem('transparent_mode') === 'true') {
        document.body.classList.add('transparent-mode');
        transparentModeToggle.checked = true;
    }

    // --- EVENT LISTENERS ---

    // 1. Send Message
    function sendMessage() {
        const text = messageInput.value.trim();
        
        if (editingMessageId) {
            // Handle Edit
            if (text) {
                socket.emit('edit-message', { id: editingMessageId, newText: text });
                cancelEdit();
            }
            return;
        }

        if (text || stagedImage) {
            const payload = {
                text: text,
                image: stagedImage,
                replyTo: replyTargetId ? findMessageObjById(replyTargetId) : null
            };
            socket.emit('chat-message', payload);
            
            messageInput.value = '';
            clearStagedImage();
            clearReply();
            messageInput.focus();
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // 2. Set Username
    setUsernameBtn.addEventListener('click', () => {
        const newName = usernameInput.value.trim();
        if (newName) {
            myUsername = newName;
            localStorage.setItem('chat_username', myUsername);
            socket.emit('set-username', { username: myUsername, avatar: myAvatar });
        }
    });

    // 3. Image Upload
    uploadBtn.addEventListener('click', () => hiddenFileInput.click());
    
    hiddenFileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // --- UPDATED: 1GB LIMIT CHECK ---
            const maxSize = 1 * 1024 * 1024 * 1024; // 1GB (approx)
            
            if (file.size > maxSize) {
                alert("File is too large! Please choose a file under 1GB.");
                this.value = ''; // Reset
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                stagedImage = e.target.result;
                imagePreview.src = stagedImage;
                imagePreviewArea.style.display = 'flex';
                messageInput.focus();
            };
            reader.readAsDataURL(file);
        }
    });

    cancelImageBtn.addEventListener('click', clearStagedImage);

    function clearStagedImage() {
        stagedImage = null;
        imagePreview.src = '';
        imagePreviewArea.style.display = 'none';
        hiddenFileInput.value = '';
    }

    // 4. Settings
    transparentModeToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            document.body.classList.add('transparent-mode');
            localStorage.setItem('transparent_mode', 'true');
        } else {
            document.body.classList.remove('transparent-mode');
            localStorage.setItem('transparent_mode', 'false');
        }
    });

    // --- SOCKET EVENTS ---

    socket.on('motd', (msg) => {
        serverMotd.textContent = msg;
    });

    socket.on('history', (history) => {
        chatBox.innerHTML = ''; // Clear current
        history.forEach(msg => appendMessage(msg));
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('chat-message', (msg) => {
        appendMessage(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('dm-received', (data) => {
        // Just append for now, can be improved to show in a different tab later
        // or highlight differently
        appendMessage(data.message); 
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('sidebar-user-list', (users) => {
        updateSidebar(users);
    });

    socket.on('message-updated', (data) => {
        const msgEl = document.getElementById(`msg-${data.id}`);
        if (msgEl) {
            const textEl = msgEl.querySelector('.message-text');
            if (textEl) {
                textEl.innerText = data.text; 
                // Add edited tag if not there
                if (!msgEl.querySelector('.edited-tag')) {
                    const tag = document.createElement('span');
                    tag.className = 'edited-tag';
                    tag.innerText = '(edited)';
                    msgEl.querySelector('.message-meta').appendChild(tag);
                }
            }
        }
    });

    socket.on('message-deleted', (id) => {
        const msgEl = document.getElementById(`msg-${id}`);
        if (msgEl) msgEl.remove();
    });

    socket.on('clear-chat', () => {
        chatBox.innerHTML = '';
        const sysMsg = document.createElement('div');
        sysMsg.className = 'system-message';
        sysMsg.innerText = 'Chat history was cleared by an admin.';
        chatBox.appendChild(sysMsg);
    });

    // --- RENDER FUNCTIONS ---

    function appendMessage(msg) {
        const div = document.createElement('div');
        
        // System / Announcement
        if (msg.type === 'system' || msg.sender === 'System' || msg.sender === 'Announcement') {
            div.className = 'system-message';
            div.innerHTML = `
                <span class="sys-time">[${msg.time}]</span> 
                <span class="sys-sender">${msg.sender}:</span> 
                <span class="sys-text">${msg.text}</span>
            `;
            chatBox.appendChild(div);
            return;
        }

        const isMe = (msg.sender === myUsername);
        const isPm = (msg.type === 'pm' || msg.type === 'private');
        
        div.className = `message ${isMe ? 'user-message' : 'other-message'} ${isPm ? 'pm-message' : ''}`;
        div.id = `msg-${msg.id}`;

        // Reply Block
        let replyHTML = '';
        if (msg.replyTo) {
            replyHTML = `
                <div class="reply-preview-in-msg">
                    <strong>${escapeHtml(msg.replyTo.sender)}</strong>: ${escapeHtml(truncate(msg.replyTo.text, 30))}
                </div>
            `;
        }

        // Image Block
        let imageHTML = '';
        if (msg.image) {
            imageHTML = `<img src="${msg.image}" class="message-image" onclick="viewImage(this.src)">`;
        }

        // Avatar
        const avatarUrl = msg.avatar || 'placeholder-avatar.png';
        const avatarHTML = `<img src="${avatarUrl}" class="message-avatar" title="${msg.sender}">`;

        // Text Content
        const textContent = escapeHtml(msg.text);

        // Edit Tag
        const editTag = msg.isEdited ? `<span class="edited-tag">(edited)</span>` : '';

        // Determine Layout Order based on self/other
        // Standard: Avatar -> Content
        // Self: Content -> Avatar (handled by CSS flex-direction or order) -> but structure is same
        
        // Let's use the structure: 
        // Avatar | ContentWrapper
        
        div.innerHTML = `
            ${!isMe ? avatarHTML : ''}
            <div class="message-content-area">
                <div class="message-sender-name">${escapeHtml(msg.sender)}</div>
                ${replyHTML}
                <div class="bubble-content">
                    ${imageHTML}
                    <div class="message-text">${textContent}</div>
                </div>
                <div class="message-meta">
                    <span class="message-time">${msg.time}</span>
                    ${editTag}
                </div>
            </div>
            ${isMe ? avatarHTML : ''}
        `;

        // Right Click Context Menu
        div.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            openContextMenu(e, msg);
        });

        chatBox.appendChild(div);
    }

    function updateSidebar(users) {
        activeUserList.innerHTML = '';
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <div class="user-avatar-small" style="background-image: url('${u.avatar || 'placeholder-avatar.png'}')">
                    <div class="status-indicator ${u.online ? 'online' : 'offline'}"></div>
                </div>
                <div class="user-name">${escapeHtml(u.username)}</div>
            `;
            // Click to DM shortcut
            div.onclick = () => {
                messageInput.value = `/msg ${u.username} `;
                messageInput.focus();
            };
            activeUserList.appendChild(div);
        });
    }

    // --- CONTEXT MENU LOGIC ---
    function openContextMenu(e, msg) {
        contextSelectedMessageId = msg.id;
        contextSelectedUser = msg.sender;
        
        // Show/Hide Edit/Delete based on ownership
        const isMyMsg = (msg.sender === myUsername);
        
        if (isMyMsg) {
            ctxEdit.style.display = 'block';
            ctxDelete.style.display = 'block';
        } else {
            ctxEdit.style.display = 'none';
            ctxDelete.style.display = 'none';
        }

        contextMenu.style.top = `${e.clientY}px`;
        contextMenu.style.left = `${e.clientX}px`;
        contextMenu.classList.add('visible');

        // Close on click elsewhere
        document.addEventListener('click', closeContextMenu, { once: true });
    }

    function closeContextMenu() {
        contextMenu.classList.remove('visible');
    }

    // Context Actions
    ctxReply.onclick = () => {
        const msgObj = findMessageObjById(contextSelectedMessageId);
        if (msgObj) startReply(msgObj);
    };

    ctxEdit.onclick = () => {
         const msgObj = findMessageObjById(contextSelectedMessageId);
         if (msgObj) startEdit(msgObj);
    };

    ctxDelete.onclick = () => {
        if(confirm("Delete this message?")) {
            socket.emit('delete-message', contextSelectedMessageId);
        }
    };

    ctxDm.onclick = () => {
        messageInput.value = `/msg ${contextSelectedUser} `;
        messageInput.focus();
    }

    // --- HELPERS ---

    function startReply(msg) {
        replyTargetId = msg.id;
        messageInput.placeholder = `Replying to ${msg.sender}...`;
        messageInput.focus();
    }

    function clearReply() {
        replyTargetId = null;
        messageInput.placeholder = "Type a message... (/msg <user> <text>)";
    }

    function startEdit(msg) {
        editingMessageId = msg.id;
        messageInput.value = msg.text;
        messageInput.focus();
        sendBtn.innerText = "Save";
        
        // Add cancel button if not exists
        if (!document.getElementById('cancel-edit-btn')) {
            const btn = document.createElement('button');
            btn.id = 'cancel-edit-btn';
            btn.innerText = 'X';
            btn.style.marginLeft = '5px';
            btn.style.backgroundColor = '#dc3545';
            btn.onclick = cancelEdit;
            document.getElementById('message-input-area').appendChild(btn);
        }
    }

    function cancelEdit() {
        editingMessageId = null;
        messageInput.value = '';
        sendBtn.innerText = "Send";
        messageInput.placeholder = "Type a message... (/msg <user> <text>)";
        const btn = document.getElementById('cancel-edit-btn');
        if (btn) btn.remove();
    }

    function findMessageObjById(id) {
        // This is a bit of a hack since we don't store full history in JS strictly,
        // but we can look at the DOM or keep a local cache.
        // For now, let's grab text from DOM or assume we can't fully reconstruct object without history array.
        // Better: The server sent us history, we should store it.
        // NOTE: In this simple version, we will grab from DOM text content.
        const el = document.getElementById(`msg-${id}`);
        if (!el) return null;
        return {
            id: id,
            sender: el.querySelector('.message-sender-name') ? el.querySelector('.message-sender-name').innerText : 'Unknown',
            text: el.querySelector('.message-text') ? el.querySelector('.message-text').innerText : '...',
        };
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function truncate(str, n){
        return (str.length > n) ? str.substr(0, n-1) + '&hellip;' : str;
    }
    
    // --- VOICE CHAT LOGIC (BASIC) ---
    
    joinVcBtn.onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            socket.emit('vc-join');
            joinVcBtn.classList.add('hidden');
            leaveVcBtn.classList.remove('hidden');
            muteVcBtn.classList.remove('hidden');
        } catch (err) {
            console.error("Mic Access Error:", err);
            alert("Could not access microphone.");
        }
    };

    leaveVcBtn.onclick = () => {
        socket.emit('vc-leave');
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        // Close peers
        Object.values(peerConnections).forEach(pc => pc.close());
        peerConnections = {};

        joinVcBtn.classList.remove('hidden');
        leaveVcBtn.classList.add('hidden');
        muteVcBtn.classList.add('hidden');
    };

    muteVcBtn.onclick = () => {
        isVcMuted = !isVcMuted;
        if (localStream) {
            localStream.getAudioTracks()[0].enabled = !isVcMuted;
        }
        muteVcBtn.innerText = isVcMuted ? "Unmute" : "Mute";
        muteVcBtn.style.backgroundColor = isVcMuted ? "#dc3545" : "#ffc107";
        socket.emit('vc-mute-toggle', isVcMuted);
    };

    socket.on('vc-user-list-update', (users) => {
        vcUserList.innerHTML = '';
        if (users.length === 0) {
            vcUserList.innerHTML = '<div class="vc-placeholder">No one in voice.</div>';
            return;
        }
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'vc-user-item';
            div.innerHTML = `
                <div class="vc-avatar" style="background-image: url('${u.avatar}')">
                    ${u.isMuted ? '<span class="vc-mute-icon">ðŸ”‡</span>' : ''}
                </div>
                <span>${escapeHtml(u.username)}</span>
            `;
            vcUserList.appendChild(div);
        });
    });

    // WebRTC Signaling Handlers (Simplified)
    socket.on('vc-prepare-connection', async (targetId) => {
        if (!localStream) return;
        const pc = createPeerConnection(targetId);
        peerConnections[targetId] = pc;
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('signal', { target: targetId, signal: { type: 'offer', sdp: offer } });
    });

    socket.on('signal', async (data) => {
        if (!localStream) return;
        const { sender, signal } = data;
        let pc = peerConnections[sender];
        
        if (!pc) {
            pc = createPeerConnection(sender);
            peerConnections[sender] = pc;
        }

        if (signal.sdp) {
            await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
            if (signal.sdp.type === 'offer') {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('signal', { target: sender, signal: { type: 'answer', sdp: answer } });
            }
        } else if (signal.candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
        }
    });

    socket.on('vc-user-left', (id) => {
        if (peerConnections[id]) {
            peerConnections[id].close();
            delete peerConnections[id];
        }
    });

    function createPeerConnection(targetId) {
        const pc = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('signal', { target: targetId, signal: { candidate: event.candidate } });
            }
        };

        pc.ontrack = (event) => {
            const audio = new Audio();
            audio.srcObject = event.streams[0];
            audio.autoplay = true;
        };
        return pc;
    }

    // --- UTILS ---
    window.openCloak = function(url) {
        const win = window.open('about:blank', '_blank');
        if (win) {
            win.document.write(`<iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>`);
        }
    };
    
    window.viewImage = function(src) {
        const win = window.open('');
        win.document.write(`<img src="${src}" style="max-width:100%">`);
    };

</script>
</body>
</html>
