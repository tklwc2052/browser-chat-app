<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat App</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@nhost/nhost-js"></script>
<script>
    // üîë YOUR NHOST CREDENTIALS (from your prompt)
    const NHOST_SUBDOMAIN = 'kfkbjfsvpssdjtqhlncy';
    const NHOST_REGION = 'us-east-1';
    
    // Initialize the Nhost client
    const nhost = new Nhost.NhostClient({
        subdomain: NHOST_SUBDOMAIN,
        region: NHOST_REGION
    });
</script>
</head>
<body>
<div id="main-wrapper">

    <div id="chat-container">
        <div id="username-area">
            <h3>Auth:</h3>
            <input type="text" id="username-input" placeholder="enter email" required>
            <input type="password" id="password-input" placeholder="password" class="password-input" required>
            
            <button id="auth-main-btn" data-action="login">Login</button>
            <button id="auth-toggle-btn">Register</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list">
                </ul>
        </div>
        
        <div id="messages">
            </div>

        <div id="message-input-area">
            <textarea id="message-input" placeholder="type type type..." rows="1" disabled></textarea>
            <button id="file-upload-btn" title="File Upload (Not implemented)" disabled>
                üìÅ
            </button>
            <button id="send-button" disabled>Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        <h4 class="panel-title">other stuff</h4>
        <button id="launch-custom-window-btn" class="panel-btn">resizable window</button>
        <p class="panel-hint"></p>
    </div>
    
</div>

<script>
    // --- 0. Popup Mode Check ---
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('mode') === 'popup') {
        const mainWrapper = document.getElementById('main-wrapper');
        const rightPanel = document.getElementById('right-panel');
        const chatContainer = document.getElementById('chat-container');
        const messageInputArea = document.getElementById('message-input-area');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const sendButton = document.getElementById('send-button');

        if (mainWrapper) {
            mainWrapper.style.gap = '0';
            mainWrapper.style.maxWidth = '300px'; 
        }
        if (rightPanel) {
            rightPanel.style.display = 'none';
        }
        if (chatContainer) {
            chatContainer.style.maxWidth = '100%';
        }
        if (messageInputArea) {
            messageInputArea.style.flexDirection = 'column';
            messageInputArea.style.gap = '5px';
        }
        if (fileUploadBtn) {
            fileUploadBtn.style.width = '100%';
            fileUploadBtn.style.alignSelf = 'stretch';
        }
        if (sendButton) {
            sendButton.style.width = '100%';
            sendButton.style.alignSelf = 'stretch';
        }
    }
    // ------------------------------------

    const socket = io();

    // --- DOM Elements ---
    const messagesDiv = document.getElementById('messages');
    const usernameInput = document.getElementById('username-input');
    const passwordInput = document.getElementById('password-input');
    const authMainBtn = document.getElementById('auth-main-btn'); // Login/Save button
    const authToggleBtn = document.getElementById('auth-toggle-btn'); // Register/Toggle button

    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const onlineUsersList = document.getElementById('online-users-list');
    const launchCustomWindowBtn = document.getElementById('launch-custom-window-btn');

    let currentUsername = '';
    let lastUserMessageTime = 0; 
    let lastOtherMessageSender = ''; 
    
    // --- AUTHENTICATION LOGIC ---

    // Toggle button switches between Login and Register modes
    authToggleBtn.addEventListener('click', () => {
        if (authMainBtn.dataset.action === 'login') {
            // Switch to Register mode
            authMainBtn.dataset.action = 'register';
            authMainBtn.textContent = 'Register';
            authToggleBtn.textContent = 'Login Instead';
            usernameInput.placeholder = 'choose new email (required by Nhost)';
            passwordInput.placeholder = 'choose new password';
        } else {
            // Switch back to Login mode
            authMainBtn.dataset.action = 'login';
            authMainBtn.textContent = 'Login';
            authToggleBtn.textContent = 'Register';
            usernameInput.placeholder = 'enter email';
            passwordInput.placeholder = 'password';
        }
        usernameInput.focus();
    });

    authMainBtn.addEventListener('click', async () => {
        const email = usernameInput.value.trim(); 
        const password = passwordInput.value;
        const action = authMainBtn.dataset.action;

        if (!email || !password) {
            socket.emit('system-message', `Warning: Email and password are required.`);
            return;
        }

        disableAuthFields(true); // Disable while waiting for Nhost response

        try {
            let result;
            
            if (action === 'register') {
                // --- REGISTRATION with Nhost ---
                // Nhost requires email and password for sign up.
                const displayName = email.split('@')[0];
                result = await nhost.auth.signUp({ 
                    email: email, 
                    password: password,
                    options: { 
                        displayName: displayName
                    } 
                });

                if (result.error) throw result.error;

                await handleSuccessfulLogin(result.user.displayName || displayName);

            } else if (action === 'login') {
                // --- LOGIN with Nhost ---
                result = await nhost.auth.signIn({ 
                    email: email, 
                    password: password 
                });

                if (result.error) throw result.error;
                
                await handleSuccessfulLogin(result.user.displayName);
            }
            
        } catch (error) {
            console.error("Nhost Auth Error:", error);
            let errorMessage = (error.message && error.message.includes('400')) ? "Invalid credentials or user not verified." : "An unknown error occurred during authentication.";
            socket.emit('system-message', `Auth Failed: ${errorMessage}`);
            disableAuthFields(false);
        }
    });

    // --- New Handler for Login Success ---
    async function handleSuccessfulLogin(displayName) {
        currentUsername = displayName; 
        
        // 1. Tell your Socket.IO server the user's name has been verified by Nhost
        socket.emit('nhost-login-success', displayName); 

        // 2. Enable UI
        messageInput.disabled = false;
        sendButton.disabled = false;
        fileUploadBtn.disabled = false;
        messageInput.focus();
        
        // Save the email for next visit
        localStorage.setItem('chatEmail', usernameInput.value.trim()); 
        
        // Hide the auth controls
        document.getElementById('username-area').style.display = 'none';

        socket.emit('system-message', `Logged in as **${displayName}**!`);
    }
    
    // Helper to disable/enable inputs
    function disableAuthFields(disable) {
        usernameInput.disabled = disable;
        passwordInput.disabled = disable;
        authMainBtn.disabled = disable;
        authToggleBtn.disabled = disable;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const storedEmail = localStorage.getItem('chatEmail');
        if (storedEmail) {
            usernameInput.value = storedEmail;
            passwordInput.focus();
        } else {
            usernameInput.focus();
        }
        // Chat inputs start disabled until successful login
        messageInput.disabled = true;
        sendButton.disabled = true;
        fileUploadBtn.disabled = true;
    });

    // --- 3. Message Sending ---
    function sendMessage() {
        let msg = messageInput.value.trim();
        if (!msg || !currentUsername) return; 

        socket.emit('chat-message', msg);
        messageInput.value = '';
    }

    sendButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // --- 4. Message Display Helper Function (Grouping Logic) ---
    function displayMessage(formattedMessage) {
        // [Existing logic for displayMessage remains the same]
        const messageEl = document.createElement('div');
        messageEl.classList.add('message');

        const fullMatch = formattedMessage.match(/\*\*(.*?)\*\*: (.*?) \[(\d{1,2}:\d{2} (?:AM|PM))\]/);

        // --- Handle System Messages/Announcements ---
        if (!fullMatch) {
            const systemMatch = formattedMessage.match(/\*\*(.*?)\*\* (.*?) \[(\d{1,2}:\d{2} (?:
