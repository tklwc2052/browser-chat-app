<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="dm-sidebar">
        <div id="dm-header">Active Users</div>
        <div id="dm-list"></div>
    </div>

    <div id="chat-container">
        <div id="username-area">
            <div style="display:flex; align-items:center; gap:10px;">
                <label for="avatar-input" id="avatar-upload-btn" title="Click to upload avatar">
                    <img id="current-avatar-preview" src="https://via.placeholder.com/40" alt="Avatar">
                </label>
                <input type="file" id="avatar-input" accept="image/*" style="display:none;">
                <h3 id="chat-header-label">User:</h3>
            </div>
            
            <div id="username-controls">
                <input type="text" id="username-input" placeholder="Enter username...">
                <button id="set-username-btn">Join</button>
            </div>
        </div>
        
        <div id="motd-banner" style="display:none; background:#ff9800; color:black; padding:8px; text-align:center; font-weight:bold;"></div>

        <div id="messages"></div>
        
        <button id="scroll-down-btn" style="display:none;">‚Üì New Messages</button>

        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="reply-bar" style="display:none; background:#333; color:#ccc; padding:5px 10px; font-size:0.85em; justify-content:space-between; align-items:center;">
                <span id="reply-text">Replying...</span>
                <button id="cancel-reply" style="background:none; border:none; color:#ff4444; cursor:pointer;">‚úñ</button>
            </div>

            <div style="display:flex; gap:5px; padding-top:5px;">
                <button id="image-btn" title="Send Image">üì∑</button>
                <input type="file" id="chat-image-input" accept="image/*" style="display:none;">
                
                <input type="text" id="message-input" placeholder="Type a message... (Use /auth <pass> for Admin)" disabled autocomplete="off">
                <button id="send-button" disabled>Send</button>
            </div>
        </div>
    </div>

    <div id="vc-sidebar">
        <div id="vc-header">Voice Chat</div>
        <div id="vc-controls">
            <button id="join-vc-btn" class="vc-btn join">Join VC</button>
            <button id="leave-vc-btn" class="vc-btn leave" style="display:none;">Leave</button>
            <button id="mute-vc-btn" class="vc-btn mute" style="display:none;">Mute</button>
        </div>
        <div id="vc-user-list"></div>
        <div id="vc-status" style="padding:10px; font-size:0.8em; color:#aaa;">Ready to join</div>
    </div>

</div>

<div id="settings-dropdown">
    <div class="dropdown-header" onclick="toggleSettings()">
        <span>‚öôÔ∏è Settings</span>
        <span>‚ñº</span>
    </div>
    <div class="dropdown-content" id="settings-content">
        <ul class="settings-list">
            <li class="setting-item">
                <span>Dark Mode</span>
                <input type="checkbox" checked onclick="toggleTheme(this)">
            </li>
            <li class="setting-item">
                <button onclick="cloakTab()" style="width:100%; background:#444; color:white; border:none; padding:8px; cursor:pointer;">Cloak Tab</button>
            </li>
        </ul>
    </div>
</div>

<script>
    const socket = io();

    // --- DOM ELEMENTS ---
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-button');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const avatarInput = document.getElementById('avatar-input');
    const preview = document.getElementById('current-avatar-preview');
    const dmListDiv = document.getElementById('dm-list');
    const motdBanner = document.getElementById('motd-banner');
    
    // State
    let myUsername = localStorage.getItem('chatUsername') || null;
    let myAvatar = localStorage.getItem('chatAvatar') || null;
    let replyToId = null;

    // --- INITIALIZATION ---
    if (myAvatar) preview.src = myAvatar;
    if (myUsername) {
        usernameInput.value = myUsername;
    }

    // --- SOCKET LISTENERS ---

    socket.on('chat-history', (history) => {
        messagesDiv.innerHTML = ''; 
        history.forEach(addMessageToUI);
        scrollToBottom();
    });

    socket.on('chat-history-reload', (history) => {
        messagesDiv.innerHTML = '';
        history.forEach(addMessageToUI);
        addSystemMessage("üßπ Chat history refreshed by Admin.");
    });

    socket.on('chat-message', (msg) => {
        addMessageToUI(msg);
        scrollToBottom();
    });

    socket.on('system-message', (text) => addSystemMessage(text));
    socket.on('error-message', (text) => alert(text));

    socket.on('announcement', (text) => {
        const div = document.createElement('div');
        div.style.cssText = "background:#d32f2f; color:white; padding:10px; margin:10px 0; border-radius:5px; text-align:center; font-weight:bold;";
        div.innerText = "üì¢ " + text;
        messagesDiv.appendChild(div);
        scrollToBottom();
    });

    socket.on('disconnect-reason', (reason) => {
        document.body.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#111; color:red;">
                <h1>DISCONNECTED</h1>
                <h2>${reason}</h2>
                <button onclick="location.reload()" style="margin-top:20px; padding:10px;">Reconnect</button>
            </div>`;
    });

    socket.on('server-motd', (motd) => {
        if (motd) {
            motdBanner.innerText = motd;
            motdBanner.style.display = 'block';
        }
    });

    socket.on('update-user-list', (users) => {
        dmListDiv.innerHTML = '';
        users.forEach(u => {
            if (u === myUsername) return; 
            const div = document.createElement('div');
            div.className = 'dm-user';
            div.innerText = u;
            div.style.padding = "5px";
            div.style.cursor = "pointer";
            div.onclick = () => { msgInput.value = `/msg ${u} `; msgInput.focus(); }; 
            dmListDiv.appendChild(div);
        });
    });

    // --- USER INTERACTIONS ---

    setUsernameBtn.onclick = () => {
        const name = usernameInput.value.trim();
        if (!name) return;
        myUsername = name;
        localStorage.setItem('chatUsername', name);

        socket.emit('set-username', { username: name, avatar: myAvatar });
        
        usernameInput.disabled = true;
        setUsernameBtn.disabled = true;
        msgInput.disabled = false;
        sendBtn.disabled = false;
        msgInput.focus();
    };

    sendBtn.onclick = sendMessage;
    msgInput.onkeydown = (e) => { if (e.key === 'Enter') sendMessage(); };

    function sendMessage() {
        const text = msgInput.value.trim();
        if (!text) return;

        socket.emit('chat-message', { text: text, replyTo: replyToId });
        
        msgInput.value = '';
        cancelReply();
    }

    avatarInput.onchange = (e) => handleImageUpload(e.target.files[0], (res) => {
        myAvatar = res;
        preview.src = res;
        localStorage.setItem('chatAvatar', res);
        if (myUsername && usernameInput.disabled) {
            socket.emit('set-username', { username: myUsername, avatar: myAvatar });
        }
    });

    const imgBtn = document.getElementById('image-btn');
    const chatImgInput = document.getElementById('chat-image-input');
    imgBtn.onclick = () => chatImgInput.click();
    chatImgInput.onchange = (e) => handleImageUpload(e.target.files[0], (res) => {
        socket.emit('image-upload', { image: res });
    });

    function handleImageUpload(file, callback) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => callback(evt.target.result);
        reader.readAsDataURL(file);
    }

    // --- UI HELPERS ---

    function addMessageToUI(msg) {
        const div = document.createElement('div');
        div.className = msg.isSystem ? 'message system' : (msg.username === myUsername ? 'message self' : 'message other');
        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        if (msg.isSystem) {
            div.innerHTML = `<span class="timestamp">[${time}]</span> <em>${msg.text}</em>`;
        } else {
            let content = escapeHtml(msg.text);
            if (msg.image) content = `<img src="${msg.image}" class="chat-image" style="max-width:200px; border-radius:5px; cursor:pointer;" onclick="window.open(this.src)">`;
            
            let replyBlock = '';
            if (msg.replyTo) replyBlock = `<div class="reply-context" style="font-size:0.8em; color:#888; border-left:2px solid #555; padding-left:5px; margin-bottom:2px;">Replying...</div>`;

            const avatarImg = msg.avatar || 'https://via.placeholder.com/30';
            
            div.innerHTML = `
                <div class="msg-header" style="display:flex; align-items:center; gap:5px; margin-bottom:2px;">
                    <img src="${avatarImg}" class="msg-avatar" style="width:25px; height:25px; border-radius:50%;">
                    <span class="msg-username" style="font-weight:bold; cursor:pointer;" onclick="replyTo('${msg.username}')">${msg.username}</span>
                    <span class="timestamp" style="font-size:0.7em; color:#777;">${time}</span>
                </div>
                ${replyBlock}
                <div class="msg-content">${content}</div>
            `;
        }
        messagesDiv.appendChild(div);
    }

    function addSystemMessage(text) {
        const div = document.createElement('div');
        div.style.textAlign = 'center';
        div.style.color = '#888';
        div.style.fontSize = '0.8em';
        div.style.margin = '5px 0';
        div.innerHTML = `<em>${text}</em>`;
        messagesDiv.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    window.replyTo = (name) => {
        replyToId = name; 
        document.getElementById('reply-bar').style.display = 'flex';
        document.getElementById('reply-text').innerText = `Replying to ${name}`;
        msgInput.focus();
    };

    function cancelReply() {
        replyToId = null;
        document.getElementById('reply-bar').style.display = 'none';
    }
    document.getElementById('cancel-reply').onclick = cancelReply;

    function toggleSettings() {
        document.getElementById('settings-content').classList.toggle('show');
    }

    function cloakTab() {
        const win = window.open();
        win.document.body.style.margin = '0';
        win.document.body.style.height = '100vh';
        const iframe = win.document.createElement('iframe');
        iframe.style.border = 'none';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.margin = '0';
        iframe.src = window.location.href;
        win.document.body.appendChild(iframe);
        window.location.replace('https://google.com');
    }

    function toggleTheme(checkbox) {
        if (checkbox.checked) {
            document.body.style.background = '#1e1e1e';
            document.body.style.color = '#f0f0f0';
        } else {
            document.body.style.background = '#ffffff';
            document.body.style.color = '#000000';
        }
    }
    
    // Voice Chat
    const vcJoinBtn = document.getElementById('join-vc-btn');
    const vcLeaveBtn = document.getElementById('leave-vc-btn');
    vcJoinBtn.onclick = () => {
        socket.emit('vc-join');
        vcJoinBtn.style.display = 'none';
        vcLeaveBtn.style.display = 'inline-block';
        document.getElementById('vc-status').innerText = "Connected";
    };
    vcLeaveBtn.onclick = () => {
        socket.emit('vc-leave');
        vcLeaveBtn.style.display = 'none';
        vcJoinBtn.style.display = 'inline-block';
        document.getElementById('vc-status').innerText = "Disconnected";
    };
</script>
</body>
</html>
