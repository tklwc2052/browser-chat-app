<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Best Chat Ever</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="main-wrapper">

    <div id="chat-container">
        <div id="username-area">
            <button id="avatar-upload-btn" title="Set Avatar">
                <img id="current-avatar-preview" src="placeholder-avatar.png" alt="Avatar">
            </button>
            <h3>username:</h3>
            <input type="text" id="username-input" placeholder="whatr we callin ya">
            <button id="set-username-btn">Save</button>
        </div>

        <div id="online-users-area">
            <h4>whos online:</h4>
            <ul id="online-users-list"></ul>
        </div>
        
        <div id="messages"></div>

        <div id="message-input-area">
            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>
            
            <textarea id="message-input" placeholder="type type type..." rows="1"></textarea>
            <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
            
            <button id="file-upload-btn" title="Upload Image">üìÅ</button>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        
        <div class="panel-top-group">
            <div>
                <h4 class="panel-title">other stuff</h4>
                <button id="launch-custom-window-btn" class="panel-btn">resizable window</button>
            </div>

            <div>
                <h4 class="panel-title">voice chat</h4>
                <button id="vc-btn-join" class="panel-btn">Join Call</button>
                <button id="vc-btn-mute" class="panel-btn" style="display: none;">Mute</button>
                <ul id="vc-user-list"></ul>
                <div id="audio-container" style="display:none;"></div>
            </div>
        </div>

        <div class="panel-bottom-group">
            <h4 class="panel-title">Browser</h4>
            <button id="btn-cloak-launcher" class="panel-btn">Launch New Tab</button>
            <div style="margin-bottom: 15px;"></div> 
            <h4 class="panel-title">notifications</h4>
            <div class="settings-panel">
                <ul class="settings-list">
                    <li class="setting-item">
                        <span>Main Messages</span>
                        <input type="checkbox" id="setting-main" checked>
                    </li>
                    <li class="setting-item">
                        <span>Private Messages</span>
                        <input type="checkbox" id="setting-pm" checked>
                    </li>
                    <li class="setting-item">
                        <span>VC Joins/Leaves</span>
                        <input type="checkbox" id="setting-vc" checked>
                    </li>
                    <li class="setting-item">
                        <span>Sound</span>
                        <input type="checkbox" id="setting-sound" checked>
                    </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('mode') === 'popup') {
        document.getElementById('right-panel').style.display = 'none';
        document.getElementById('main-wrapper').style.maxWidth = '100%';
    }

    const socket = io();

    // --- DOM Elements ---
    const messagesDiv = document.getElementById('messages');
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const onlineUsersList = document.getElementById('online-users-list');
    const launchCustomWindowBtn = document.getElementById('launch-custom-window-btn');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');
    const vcBtnJoin = document.getElementById('vc-btn-join');
    const vcBtnMute = document.getElementById('vc-btn-mute');
    const vcUserList = document.getElementById('vc-user-list');
    const audioContainer = document.getElementById('audio-container');
    
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');

    // Notification Checkboxes
    const settingMain = document.getElementById('setting-main');
    const settingPM = document.getElementById('setting-pm');
    const settingVC = document.getElementById('setting-vc');
    const settingSound = document.getElementById('setting-sound');

    let currentUsername = '';
    let currentAvatarBase64 = ''; 
    let lastMessageSender = ''; 
    let stagedImage = null; 
    
    let localStream = null;
    let peers = {}; 
    let isInVC = false;
    let audioCtx; 
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // ==========================================
    // --- NOTIFICATION LOGIC ---
    // ==========================================

    const loadSetting = (key, checkbox) => {
        const saved = localStorage.getItem(key);
        if (saved !== null) checkbox.checked = (saved === 'true');
    };
    loadSetting('notif-main', settingMain);
    loadSetting('notif-pm', settingPM);
    loadSetting('notif-vc', settingVC);
    loadSetting('notif-sound', settingSound);

    const saveSetting = (key, checkbox) => {
        checkbox.addEventListener('change', () => {
            localStorage.setItem(key, checkbox.checked);
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });
    };
    saveSetting('notif-main', settingMain);
    saveSetting('notif-pm', settingPM);
    saveSetting('notif-vc', settingVC);
    saveSetting('notif-sound', settingSound);

    function playNotificationSound() {
        if (!settingSound.checked) return;
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, ctx.currentTime);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
    }

    function triggerNotification(title, body) {
        if (document.hidden && Notification.permission === 'granted') {
            const n = new Notification(title, { 
                body: body, 
                icon: 'placeholder-avatar.png',
                requireInteraction: true // Persistent
            });
            playNotificationSound();
        }
    }

    // ==========================================
    // --- CORE LOGIC ---
    // ==========================================
