<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The C&C Corp chat</title>
<link rel="stylesheet" href="styles.css">
<script src="/socket.io/socket.io.js"></script>
<style>
    /* SIDEBAR STYLES (Added here so you don't have to edit styles.css yet) */
    #sidebar {
        width: 220px;
        background-color: #252526;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        padding: 10px;
        overflow-y: auto;
        flex-shrink: 0;
    }
    .sidebar-btn {
        background: none; border: none; color: #aaa;
        text-align: left; padding: 10px; cursor: pointer;
        border-radius: 5px; font-size: 1em; width: 100%;
        display: flex; align-items: center; gap: 10px;
        transition: background 0.2s;
    }
    .sidebar-btn:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
    .sidebar-btn.active { background-color: #007acc; color: white; }
    
    .sidebar-section {
        font-size: 0.75em; text-transform: uppercase; color: #666;
        margin-top: 20px; margin-bottom: 5px; padding-left: 5px; font-weight: bold;
    }

    .user-item {
        display: flex; align-items: center; padding: 8px;
        cursor: pointer; border-radius: 4px; color: #ccc;
        position: relative;
    }
    .user-item:hover { background-color: rgba(255,255,255,0.05); }
    .user-item.active { background-color: rgba(255,255,255,0.1); color: #fff; border-left: 3px solid #007acc; }
    
    .user-status-dot {
        width: 8px; height: 8px; border-radius: 50%;
        background-color: #666; margin-right: 10px;
    }
    .user-status-dot.online { background-color: #4caf50; box-shadow: 0 0 5px #4caf50; }

    .unread-badge {
        background-color: #dc3545; color: white; font-size: 0.7em;
        padding: 2px 6px; border-radius: 10px; margin-left: auto;
        display: none;
    }
    .unread-badge.show { display: block; }

    #chat-container { display: flex; flex-direction: column; flex-grow: 1; }
    #online-users-area { display: none; } /* Hide old user list */
</style>
</head>
<body>
<div id="main-wrapper" style="display: flex; height: 100vh;">

    <div id="sidebar">
        <div id="username-display" style="margin-bottom: 20px; text-align: center;">
            <button id="avatar-upload-btn" style="background:none; border:none; cursor:pointer;">
                <img id="current-avatar-preview" src="placeholder-avatar.png" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
            </button>
            <div id="my-username-label" style="font-weight: bold; margin-top: 5px; color: white;">Guest</div>
        </div>

        <button id="btn-global-chat" class="sidebar-btn active">
            <span>üåê</span> Global Chat
        </button>

        <div class="sidebar-section">Direct Messages</div>
        <div id="dm-user-list">
            </div>
    </div>

    <div id="chat-container">
        
        <div id="username-area" style="padding: 10px; border-bottom: 1px solid #333;">
            <div id="username-setup-div">
                <input type="text" id="username-input" placeholder="Enter username..." style="padding: 5px;">
                <button id="set-username-btn">Join</button>
            </div>
            <div id="chat-header" style="font-weight: bold; margin-top:5px;"># Global Chat</div>
        </div>
        
        <div id="messages" style="flex-grow: 1; overflow-y: auto; padding: 10px;"></div>
        <div id="typing-indicator"></div>

        <div id="message-input-area">
            <div id="image-preview-area" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn">X</button>
            </div>
            
            <textarea id="message-input" placeholder="Message #global..." rows="1"></textarea>
            <input type="file" id="hidden-file-input" accept="image/*" style="display: none;">
            
            <button id="file-upload-btn">üìÅ</button>
            <button id="send-button">Send</button>
        </div>
    </div>
    
    <div id="right-panel">
        <div class="panel-top-group">
            <h4 class="panel-title">Voice Chat</h4>
            <button id="vc-btn-join" class="panel-btn">Join Call</button>
            <div id="audio-container"></div>
        </div>

        <div class="panel-bottom-group">
            <h4 class="panel-title">Appearance</h4>
            <button id="btn-bg-upload" class="panel-btn">Change BG</button>
            <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">
            <button id="btn-bg-reset" class="panel-btn" style="background-color: #dc3545;">Reset BG</button>
        </div>
    </div>
</div>

<script>
    const socket = io();

    // Elements
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const btnGlobalChat = document.getElementById('btn-global-chat');
    const dmUserList = document.getElementById('dm-user-list');
    const chatHeader = document.getElementById('chat-header');
    
    const usernameInput = document.getElementById('username-input');
    const setUsernameBtn = document.getElementById('set-username-btn');
    const usernameSetupDiv = document.getElementById('username-setup-div');
    const myUsernameLabel = document.getElementById('my-username-label');
    const avatarUploadBtn = document.getElementById('avatar-upload-btn');
    const currentAvatarPreview = document.getElementById('current-avatar-preview');

    const fileUploadBtn = document.getElementById('file-upload-btn');
    const hiddenFileInput = document.getElementById('hidden-file-input');
    const imagePreviewArea = document.getElementById('image-preview-area');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');

    // BG Upload Elements
    const btnBgUpload = document.getElementById('btn-bg-upload');
    const bgUploadInput = document.getElementById('bg-upload-input');
    const btnBgReset = document.getElementById('btn-bg-reset');

    // State
    let currentUsername = '';
    let currentAvatarBase64 = '';
    let stagedImage = null; 
    let activeChat = 'global'; 
    let globalMessages = [];
    let dmMessages = {}; 
    let knownUsers = []; 
    let unreadCounts = {}; 

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const storedUser = localStorage.getItem('chatUsername');
        const storedAvatar = localStorage.getItem('chatAvatar');
        const storedBg = localStorage.getItem('custom-bg');

        if (storedAvatar) { 
            currentAvatarBase64 = storedAvatar; 
            currentAvatarPreview.src = storedAvatar; 
        }
        if (storedBg) {
            document.body.style.backgroundImage = `url(${storedBg})`;
            document.body.classList.add('transparent-mode');
        }
        if (storedUser) { 
            usernameInput.value = storedUser; 
            joinChat(storedUser);
        }
    });

    setUsernameBtn.addEventListener('click', () => joinChat(usernameInput.value));

    function joinChat(username) {
        if (!username.trim()) return;
        currentUsername = username.trim();
        localStorage.setItem('chatUsername', currentUsername);
        
        usernameSetupDiv.style.display = 'none';
        myUsernameLabel.innerText = currentUsername;

        socket.emit('set-username', { 
            username: currentUsername, 
            avatar: currentAvatarBase64 || 'placeholder-avatar.png' 
        });
    }

    // --- NAVIGATION ---
    function getDmKey(userA, userB) {
        return [userA, userB].sort().join(':');
    }

    function switchChat(target) {
        activeChat = target;
        messagesDiv.innerHTML = '';
        
        if (target === 'global') {
            btnGlobalChat.classList.add('active');
            chatHeader.innerText = "# Global Chat";
            messageInput.placeholder = "Message #global...";
            renderMessages(globalMessages);
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        } else {
            btnGlobalChat.classList.remove('active');
            chatHeader.innerText = `@ ${target}`;
            messageInput.placeholder = `Message @${target}...`;
            
            document.querySelectorAll('.user-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.username === target) {
                    el.classList.add('active');
                    unreadCounts[target] = 0;
                    const badge = el.querySelector('.unread-badge');
                    if(badge) badge.classList.remove('show');
                }
            });

            const key = getDmKey(currentUsername, target);
            if (dmMessages[key]) renderMessages(dmMessages[key]);
        }
    }

    btnGlobalChat.addEventListener('click', () => switchChat('global'));

    // --- USERS LIST ---
    socket.on('user-list-update', (users) => {
        knownUsers = users;
        renderSidebarUsers();
    });

    function renderSidebarUsers() {
        dmUserList.innerHTML = '';
        knownUsers.forEach(u => {
            if (u.username === currentUsername) return;

            const div = document.createElement('div');
            div.className = 'user-item';
            div.dataset.username = u.username;
            if (activeChat === u.username) div.classList.add('active');
            
            // Basic "is online" check (last seen within 60s)
            const isOnline = (new Date() - new Date(u.lastSeen)) < 60000; 

            div.innerHTML = `
                <div class="user-status-dot ${isOnline ? 'online' : ''}"></div>
                <img src="${u.avatar || 'placeholder-avatar.png'}" style="width:30px; height:30px; border-radius:50%; margin-right:10px; object-fit:cover;">
                <span style="flex-grow:1; overflow:hidden; text-overflow:ellipsis;">${u.username}</span>
                <span class="unread-badge ${unreadCounts[u.username] > 0 ? 'show' : ''}">${unreadCounts[u.username] || ''}</span>
            `;

            div.addEventListener('click', () => switchChat(u.username));
            dmUserList.appendChild(div);
        });
    }

    // --- MESSAGING ---
    socket.on('history', (msgs) => {
        globalMessages = msgs;
        if (activeChat === 'global') renderMessages(globalMessages);
    });

    socket.on('dm-history-sync', (dms) => {
        dmMessages = dms;
    });

    socket.on('chat-message', (msg) => {
        if (msg.type === 'general' || msg.type === 'system') {
            globalMessages.push(msg);
            if (activeChat === 'global') displaySingleMessage(msg);
        }
        else if (msg.type === 'private') {
            const otherPerson = (msg.sender === currentUsername) ? msg.target : msg.sender;
            const key = getDmKey(currentUsername, otherPerson);
            
            if (!dmMessages[key]) dmMessages[key] = [];
            dmMessages[key].push(msg);

            if (activeChat === otherPerson) {
                displaySingleMessage(msg);
            } else {
                if (msg.sender !== currentUsername) {
                    unreadCounts[msg.sender] = (unreadCounts[msg.sender] || 0) + 1;
                    renderSidebarUsers();
                }
            }
        }
    });

    function sendMessage() {
        const text = messageInput.value.trim();
        if ((!text && !stagedImage) || !currentUsername) return;

        socket.emit('chat-message', { 
            text, 
            image: stagedImage,
            avatar: currentAvatarBase64, // Send current avatar with msg
            type: activeChat === 'global' ? 'general' : 'private',
            target: activeChat === 'global' ? null : activeChat
        });
        
        messageInput.value = '';
        stagedImage = null;
        imagePreviewArea.style.display = 'none';
        hiddenFileInput.value = '';
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // --- RENDER UTILS ---
    function renderMessages(list) {
        messagesDiv.innerHTML = '';
        list.forEach(msg => displaySingleMessage(msg));
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displaySingleMessage(msg) {
        const div = document.createElement('div');
        div.className = 'message ' + (msg.sender === currentUsername ? 'user-message' : 'other-message');
        
        let contentHtml = '';
        if (msg.image) contentHtml += `<img src="${msg.image}" class="message-image" onclick="window.open('${msg.image}')">`;
        if (msg.text) contentHtml += `<div>${msg.text}</div>`;
        
        div.innerHTML = `
            ${msg.sender !== currentUsername ? `<img src="${msg.avatar || 'placeholder-avatar.png'}" class="avatar">` : ''}
            <div class="message-content-area">
                ${msg.sender !== currentUsername ? `<div class="message-username">${msg.sender}</div>` : ''}
                <div class="bubble-content ${msg.type === 'private' ? 'bubble-private' : ''}">${contentHtml}</div>
                <div class="message-time">${msg.time}</div>
            </div>
        `;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // --- FILE UPLOAD (WITH GIF FIX) ---
    function handleFileSelection(file) {
        if (!file || !file.type.startsWith('image/')) return;

        // GIF FIX: Skip resizing for GIFs
        if (file.type === 'image/gif') {
            const reader = new FileReader();
            reader.onload = (e) => {
                stagedImage = e.target.result;
                imagePreview.src = stagedImage;
                imagePreviewArea.style.display = 'flex';
            };
            reader.readAsDataURL(file);
            return; 
        }

        // Resize others
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // Simple resize logic
                const scale = Math.min(800 / img.width, 800 / img.height, 1);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                stagedImage = canvas.toDataURL('image/jpeg', 0.7);
                imagePreview.src = stagedImage;
                imagePreviewArea.style.display = 'flex';
            };
        };
    }

    fileUploadBtn.addEventListener('click', () => hiddenFileInput.click());
    hiddenFileInput.addEventListener('change', (e) => handleFileSelection(e.target.files[0]));
    
    // Paste Support
    window.addEventListener('paste', (e) => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                handleFileSelection(item.getAsFile());
            }
        }
    });

    removeImageBtn.addEventListener('click', () => {
        stagedImage = null;
        imagePreviewArea.style.display = 'none';
        hiddenFileInput.value = '';
    });

    // --- AVATAR UPLOAD ---
    avatarUploadBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                currentAvatarBase64 = evt.target.result;
                currentAvatarPreview.src = currentAvatarBase64;
                localStorage.setItem('chatAvatar', currentAvatarBase64);
                if(currentUsername) socket.emit('set-username', { username: currentUsername, avatar: currentAvatarBase64 });
            };
            reader.readAsDataURL(file);
        };
        input.click();
    });

    // --- BG UPLOAD ---
    btnBgUpload.addEventListener('click', () => bgUploadInput.click());
    bgUploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
            localStorage.setItem('custom-bg', evt.target.result);
            document.body.style.backgroundImage = `url(${evt.target.result})`;
            document.body.classList.add('transparent-mode');
        };
        reader.readAsDataURL(file);
    });
    btnBgReset.addEventListener('click', () => {
        localStorage.removeItem('custom-bg');
        document.body.style.backgroundImage = '';
        document.body.classList.remove('transparent-mode');
    });

    // --- VC BUTTONS (Logic truncated for brevity, but buttons exist) ---
    const vcBtnJoin = document.getElementById('vc-btn-join');
    vcBtnJoin.addEventListener('click', () => alert("VC is currently just a placeholder in this update! Focus on DMs first."));

</script>
</body>
</html>
